<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>q3dfit.q3dout &mdash; q3dfit 1.1.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=00f267c6"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            q3dfit
          </a>
              <div class="version">
                1.1.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">q3dfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fitting.html">Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIR-configuration.html">MIR Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html">checkcomp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.contfit">contfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.cube_bin">cube_bin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.exceptions">q3dfit.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.fitloop">q3dfit.fitloop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.fitspec">q3dfit.fitspec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.gdtemp">q3dfit.gdtemp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.interp_temp_quest">q3dfit.interp_temp_quest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.interptemp">q3dfit.interptemp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.jnb">q3dfit.jnb</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.jwstlinez">q3dfit.jwstlinez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.lineinit">q3dfit.lineinit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.linelist">q3dfit.linelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.masklin">q3dfit.masklin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#q3dfit-mk-npy-templ">q3dfit.mk_npy_templ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.nonJWST_datacube_converter">q3dfit.nonJWST_datacube_converter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.observedlinez">q3dfit.observedlinez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.plot">q3dfit.plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#q3dfit-psf-sub">q3dfit.psf_sub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dcollect">q3dfit.q3dcollect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3df">q3dfit.q3df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3df_helperFunctions">q3dfit.q3df_helperFunctions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3din">q3dfit.q3din</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dmath">q3dfit.q3dmath</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dout">q3dfit.q3dout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dpro">q3dfit.q3dpro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dutil">q3dfit.q3dutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.qsohostfcn">q3dfit.qsohostfcn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.questfitfcn">q3dfit.questfitfcn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.readcube">q3dfit.readcube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.readtemp">q3dfit.readtemp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.rebin">q3dfit.rebin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.restline">q3dfit.restline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#q3dfit-sdi">q3dfit.sdi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.select_spaxels">q3dfit.select_spaxels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.spectConvol">q3dfit.spectConvol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.writeout_quest">q3dfit.writeout_quest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit">Module contents</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">q3dfit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">q3dfit.q3dout</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for q3dfit.q3dout</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Caroline Bertemes, based on q3da (now q3di) by Hadley Lim</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">q3dfit.q3dutil</span> <span class="k">as</span> <span class="nn">q3dutil</span>

<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="kn">import</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">gaussian_sigma_to_fwhm</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span> <span class="nn">importlib</span> <span class="kn">import</span> <span class="n">import_module</span>
<span class="kn">from</span> <span class="nn">ppxf.ppxf_util</span> <span class="kn">import</span> <span class="n">log_rebin</span>
<span class="kn">from</span> <span class="nn">q3dfit.q3dmath</span> <span class="kn">import</span> <span class="n">gaussflux</span>
<span class="kn">from</span> <span class="nn">q3dfit.q3dutil</span> <span class="kn">import</span> <span class="n">lmlabel</span>
<span class="kn">from</span> <span class="nn">q3dfit.qsohostfcn</span> <span class="kn">import</span> <span class="n">qsohostfcn</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">constants</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>


<div class="viewcode-block" id="load_q3dout">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.load_q3dout">[docs]</a>
<span class="k">def</span> <span class="nf">load_q3dout</span><span class="p">(</span><span class="n">q3di</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">cubedim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load object after it&#39;s been saved to a file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    q3di : object</span>
<span class="sd">        q3dinit object.</span>
<span class="sd">    col : int</span>
<span class="sd">        Column index.</span>
<span class="sd">    row : int</span>
<span class="sd">        Row index.</span>
<span class="sd">    cubedim : int, optional</span>
<span class="sd">        Dimension of cube (1, 2, or 3). If None, will try to get from q3di or </span>
<span class="sd">        cube itself.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    q3dout : object</span>
<span class="sd">        q3dout object.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># convert from string to object if necessary.</span>
    <span class="n">q3dii</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_q3dio</span><span class="p">(</span><span class="n">q3di</span><span class="p">)</span>

    <span class="n">filelab</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{0.outdir}{0.label}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">q3dii</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cubedim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">q3dii</span><span class="p">,</span> <span class="s1">&#39;cubedim&#39;</span><span class="p">):</span>
            <span class="n">cubedim</span> <span class="o">=</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">cubedim</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;load_q3dout: q3di has no attribute cubedim, loading cube&#39;</span><span class="p">)</span>
            <span class="n">cube</span><span class="p">,</span> <span class="n">vormap</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_Cube</span><span class="p">(</span><span class="n">q3dii</span><span class="p">)</span>
            <span class="n">cubedim</span> <span class="o">=</span> <span class="n">cube</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">ndim</span>
    <span class="k">if</span> <span class="n">cubedim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">filelab</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cubedim</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">filelab</span> <span class="o">+=</span> <span class="s1">&#39;_</span><span class="si">{:04d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="n">infile</span> <span class="o">=</span> <span class="n">filelab</span> <span class="o">+</span> <span class="s1">&#39;.npy&#39;</span>

    <span class="c1"># this should work for both q3di and q3do</span>
    <span class="n">q3dout</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_q3dio</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="c1"># add file label to object</span>
    <span class="n">q3dout</span><span class="o">.</span><span class="n">filelab</span> <span class="o">=</span> <span class="n">filelab</span>
    <span class="k">return</span> <span class="n">q3dout</span></div>



<div class="viewcode-block" id="q3dout">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout">[docs]</a>
<span class="k">class</span> <span class="nc">q3dout</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This class defines a q3dout object, which is created by q3df when</span>
<span class="sd">    running on any single spaxel. It collects all the output of</span>
<span class="sd">    q3df/fitspec and contains functions to generate plots for a single</span>
<span class="sd">    spaxel.</span>

<span class="sd">    (For multi-spaxel processing instead, please see q3dpro.)</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    wave : ndarray</span>
<span class="sd">        Wavelength array.</span>
<span class="sd">    spec : ndarray</span>
<span class="sd">        Flux array.</span>
<span class="sd">    spec_err : ndarray</span>
<span class="sd">        Error array.</span>
<span class="sd">    fitrange : ndarray</span>
<span class="sd">        Wavelength range for fitting.</span>
<span class="sd">    col : int</span>
<span class="sd">        Column index.</span>
<span class="sd">    row : int</span>
<span class="sd">        Row index.</span>
<span class="sd">    gd_indx : ndarray</span>
<span class="sd">        Good data indices.</span>
<span class="sd">    fitran_indx : ndarray</span>
<span class="sd">        Fit range indices.</span>
<span class="sd">    fluxunit : str</span>
<span class="sd">        Flux unit.</span>
<span class="sd">    waveunit : str</span>
<span class="sd">        Wavelength unit.</span>
<span class="sd">    fluxnorm : float</span>
<span class="sd">        Flux normalization.</span>
<span class="sd">    pixarea_sqas : float</span>
<span class="sd">        Pixel area in square arcseconds.</span>
<span class="sd">    nogood : bool</span>
<span class="sd">        No good data present.</span>
<span class="sd">    docontfit : bool</span>
<span class="sd">        Do continuum fit.</span>
<span class="sd">    dolinefit : bool</span>
<span class="sd">        Do line fit.</span>
<span class="sd">    linelist : dict</span>
<span class="sd">        List of emission line rest-frame wavelengths.</span>
<span class="sd">    linelabel : dict</span>
<span class="sd">        Line labels.</span>
<span class="sd">    fitstatus : dict</span>
<span class="sd">        Fit status.</span>
<span class="sd">    maxncomp : int</span>
<span class="sd">        Maximum number of components.</span>
<span class="sd">    nfev : int</span>
<span class="sd">        Number of function evaluations.</span>
<span class="sd">    noemlinmask : dict</span>
<span class="sd">        Mask for regions with emission lines.</span>
<span class="sd">    redchisq : float</span>
<span class="sd">        Reduced chi-squared.</span>
<span class="sd">    param : dict</span>
<span class="sd">        Best-fit parameters.</span>
<span class="sd">    parinit : dict</span>
<span class="sd">        Initial parameters.</span>
<span class="sd">    perror : dict</span>
<span class="sd">        Parameter errors.</span>
<span class="sd">    perror_resid : dict</span>
<span class="sd">        Parameter errors from residuals.</span>
<span class="sd">    perror_errspec : dict</span>
<span class="sd">        Parameter errors from error spectrum.</span>
<span class="sd">    siglim : float</span>
<span class="sd">        Sigma limits for emission lines.</span>
<span class="sd">    covar : ndarray</span>
<span class="sd">        Covariance matrix. Added/updated by init_linefit().</span>
<span class="sd">    dof : int</span>
<span class="sd">        Degrees of freedom. Added/updated by init_linefit().</span>
<span class="sd">    line_dat : dict</span>
<span class="sd">        Line data. Added/updated by init_linefit().</span>
<span class="sd">    line_fit : dict</span>
<span class="sd">        Line fit. Added/updated by init_linefit().</span>
<span class="sd">    cont_dat : dict</span>
<span class="sd">        Continuum data.  Added/updated by init_contfit().</span>
<span class="sd">    cont_fit : dict</span>
<span class="sd">        Continuum fit. Added/updated by init_contfit().</span>
<span class="sd">    ct_method : str</span>
<span class="sd">        Continuum fit method. Added/updated by init_contfit().</span>
<span class="sd">    ct_coeff : dict</span>
<span class="sd">        Continuum fit coefficients. Added/updated by init_contfit().</span>
<span class="sd">    ct_ebv : float</span>
<span class="sd">        E(B-V) value from continuum fit. Added/updated by init_contfit().</span>
<span class="sd">    ct_add_poly_weights : dict</span>
<span class="sd">        Additive polynomial weights for continuum fit. Added/updated by</span>
<span class="sd">    ct_ppxf_sigma : float</span>
<span class="sd">        Best-fit sigma from ppxf. Added/updated by init_contfit().</span>
<span class="sd">    ct_ppxf_sigma_err : float</span>
<span class="sd">        Error in best-fit sigma from ppxf. Added/updated by init_contfit().    </span>
<span class="sd">    ct_rchisq : float</span>
<span class="sd">        Reduced chi-squared from continuum fit. Added/updated by init_contfit().</span>
<span class="sd">    ct_indx : ndarray</span>
<span class="sd">        Continuum fit indices. Added/updated by init_contfit().</span>
<span class="sd">    zstar : float</span>
<span class="sd">        Best-fit zstar. Added/updated by init_contfit().</span>
<span class="sd">    zstar_err : float</span>
<span class="sd">        Error in best-fit zstar. Added/updated by init_contfit().</span>
<span class="sd">    add_poly_degree : int</span>
<span class="sd">        Degree of additive polynomial for continuum fit. Added/updated by</span>
<span class="sd">    cont_fit_poly : ndarray</span>
<span class="sd">        Polynomial component of continuum fit. Added/updated by sepcontpars().</span>
<span class="sd">    cont_fit_stel : ndarray</span>
<span class="sd">        Stellar component of continuum fit. Added/updated by sepcontpars().</span>
<span class="sd">    qsomod : float</span>
<span class="sd">        QSO component of continuum fit. Added/updated by sepcontpars().</span>
<span class="sd">    hostmod : float</span>
<span class="sd">        Host component of continuum fit. Added/updated by sepcontpars().</span>
<span class="sd">    polymod_refit : ndarray</span>
<span class="sd">        Polynomial component of continuum fit, if refit with fitqsohost. </span>
<span class="sd">        Added/updated by sepcontpars().</span>
<span class="sd">    blrpar : dict</span>
<span class="sd">        BLR fit parameters, if using fitqsohost. Added/updated by sepcontpars().</span>
<span class="sd">    line_fitpars : dict</span>
<span class="sd">        Line fit parameters. Added/updated by sepfitpars().</span>
<span class="sd">    tflux : dict</span>
<span class="sd">        Total fluxes of emission lines. Added/updated by sepfitpars().</span>
<span class="sd">    tfluxerr : dict</span>
<span class="sd">        Total flux errors of emission lines. Added/updated by sepfitpars().</span>
<span class="sd">    filelab : str</span>
<span class="sd">        File label for plotting methods. Added/updated by load_q3dout().</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    init_linefit(linelist, linelabel, maxncomp, covar=None, dof=None,</span>
<span class="sd">                fitstatus=None, line_dat=None, line_fit=None, nfev=None,</span>
<span class="sd">                noemlinmask=None, redchisq=None, param=None, parinit=None,</span>
<span class="sd">                perror=None, perror_resid=None, perror_errspec=None, siglim=None)</span>
<span class="sd">        Initialize line fit parameters.</span>

<span class="sd">    init_contfit(ct_method=&#39;CONTINUUM SUBTRACTED&#39;, ct_coeff=None, ct_ebv=None,</span>
<span class="sd">                ct_add_poly_weights=None, ct_ppxf_sigma=None, ct_ppxf_sigma_err=None,</span>
<span class="sd">                ct_rchisq=None, cont_dat=None, cont_fit=None, ct_indx=None,</span>
<span class="sd">                zstar=None, zstar_err=None)</span>
<span class="sd">        Initialize continuum fit parameters.</span>
<span class="sd">    </span>
<span class="sd">    sepfitpars(waveran=None, doublets=None, ignoreres=False)</span>
<span class="sd">        Convert output of LMFIT, with best-fit line parameters in a single</span>
<span class="sd">        array, into a dictionary with separate arrays for different line</span>
<span class="sd">        parameters. Compute total line fluxes from the best-fit line</span>
<span class="sd">        parameters.</span>
<span class="sd">        :no-index:</span>

<span class="sd">    sepcontpars(q3di)</span>
<span class="sd">        Compute PPXF components: additive polynomial and stellar fit.</span>

<span class="sd">    plot_linefit(q3di, q3dout, line, comp, ax=None, fig=None, show=True,</span>
<span class="sd">                save=False, savepath=None, saveformat=&#39;pdf&#39;, **kwargs)</span>
<span class="sd">        Plot line fit.</span>

<span class="sd">    plot_contfit(q3di, q3dout, ax=None, fig=None, show=True, save=False,</span>
<span class="sd">                savepath=None, saveformat=&#39;pdf&#39;, **kwargs)</span>
<span class="sd">        Plot continuum fit.</span>
<span class="sd">        </span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wave</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">spec_err</span><span class="p">,</span> <span class="n">fitrange</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">row</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">gd_indx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fitran_indx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fluxunit</span><span class="o">=</span><span class="s1">&#39;erg/s/cm^2/micron&#39;</span><span class="p">,</span>
                 <span class="n">waveunit</span><span class="o">=</span><span class="s1">&#39;micron&#39;</span><span class="p">,</span> <span class="n">fluxnorm</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">pixarea_sqas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">nogood</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize q3dout object.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitrange</span> <span class="o">=</span> <span class="n">fitrange</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">wave</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec_err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">(</span><span class="n">spec_err</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fluxunit</span> <span class="o">=</span> <span class="n">fluxunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waveunit</span> <span class="o">=</span> <span class="n">waveunit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fluxnorm</span> <span class="o">=</span> <span class="n">fluxnorm</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pixarea_sqas</span> <span class="o">=</span> <span class="n">pixarea_sqas</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fitran_indx</span> <span class="o">=</span> <span class="n">fitran_indx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gd_indx</span> <span class="o">=</span> <span class="n">gd_indx</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">docontfit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dolinefit</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nogood</span> <span class="o">=</span> <span class="n">nogood</span> <span class="c1"># no good data present</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">col</span> <span class="o">=</span> <span class="n">col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">row</span> <span class="o">=</span> <span class="n">row</span>

<div class="viewcode-block" id="q3dout.init_linefit">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout.init_linefit">[docs]</a>
    <span class="k">def</span> <span class="nf">init_linefit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linelist</span><span class="p">,</span> <span class="n">linelabel</span><span class="p">,</span> <span class="n">maxncomp</span><span class="p">,</span> <span class="n">covar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">dof</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fitstatus</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">line_dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">line_fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nfev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">noemlinmask</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">redchisq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">param</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">parinit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perror</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">perror_resid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">perror_errspec</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">siglim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dolinefit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Line fit parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covar</span> <span class="o">=</span> <span class="n">covar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dof</span> <span class="o">=</span> <span class="n">dof</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_dat</span> <span class="o">=</span> <span class="n">line_dat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_fit</span> <span class="o">=</span> <span class="n">line_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span> <span class="o">=</span> <span class="n">linelist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linelabel</span> <span class="o">=</span> <span class="n">linelabel</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fitstatus</span> <span class="o">=</span> <span class="n">fitstatus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxncomp</span> <span class="o">=</span> <span class="n">maxncomp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nfev</span> <span class="o">=</span> <span class="n">nfev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">noemlinmask</span> <span class="o">=</span> <span class="n">noemlinmask</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parinit</span> <span class="o">=</span> <span class="n">parinit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param</span> <span class="o">=</span> <span class="n">param</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perror</span> <span class="o">=</span> <span class="n">perror</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perror_errspec</span> <span class="o">=</span> <span class="n">perror_errspec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">perror_resid</span> <span class="o">=</span> <span class="n">perror_resid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redchisq</span> <span class="o">=</span> <span class="n">redchisq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">siglim</span> <span class="o">=</span> <span class="n">siglim</span></div>


<div class="viewcode-block" id="q3dout.init_contfit">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout.init_contfit">[docs]</a>
    <span class="k">def</span> <span class="nf">init_contfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct_method</span><span class="o">=</span><span class="s1">&#39;CONTINUUM SUBTRACTED&#39;</span><span class="p">,</span>
                     <span class="n">ct_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ct_ebv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ct_add_poly_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">ct_ppxf_sigma</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ct_ppxf_sigma_err</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">ct_rchisq</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cont_dat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cont_fit</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">ct_indx</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zstar</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zstar_err</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
                     <span class="c1"># cont_fit_pretweak=None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">docontfit</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Continuum fit parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_method</span> <span class="o">=</span> <span class="n">ct_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span> <span class="o">=</span> <span class="n">ct_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_ebv</span> <span class="o">=</span> <span class="n">ct_ebv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zstar</span> <span class="o">=</span> <span class="n">zstar</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">zstar_err</span> <span class="o">=</span> <span class="n">zstar_err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_add_poly_weights</span> <span class="o">=</span> <span class="n">ct_add_poly_weights</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_ppxf_sigma</span> <span class="o">=</span> <span class="n">ct_ppxf_sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_ppxf_sigma_err</span> <span class="o">=</span> <span class="n">ct_ppxf_sigma_err</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_rchisq</span> <span class="o">=</span> <span class="n">ct_rchisq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cont_dat</span> <span class="o">=</span> <span class="n">cont_dat</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cont_fit</span> <span class="o">=</span> <span class="n">cont_fit</span>
        <span class="c1"># self.cont_fit_pretweak = cont_fit_pretweak</span>

        <span class="c1"># gd_indx is applied, and then ct_indx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ct_indx</span> <span class="o">=</span> <span class="n">ct_indx</span></div>


<div class="viewcode-block" id="q3dout.sepfitpars">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout.sepfitpars">[docs]</a>
    <span class="k">def</span> <span class="nf">sepfitpars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">waveran</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">doublets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ignoreres</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert output of LMFIT, with best-fit line parameters in a single</span>
<span class="sd">        array, into a dictionary with separate arrays for different line</span>
<span class="sd">        parameters. Compute total line fluxes from the best-fit line</span>
<span class="sd">        parameters.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        waveran: ndarray, optional</span>
<span class="sd">            Set to upper and lower limits to return line parameters only</span>
<span class="sd">            for lines within the given wavelength range. Lines outside this</span>
<span class="sd">            range have fluxes set to 0.</span>
<span class="sd">        doublets: dict, optional</span>
<span class="sd">            Dictionary of doublet lines for which to combine fluxes.</span>
<span class="sd">        ignoreres: bool, optional</span>
<span class="sd">            Ignore spectral resolution in computing observed sigmas and peak </span>
<span class="sd">            fluxes. This is mainly for backward compatibility with old versions,</span>
<span class="sd">            which did not store the spectral resolution in an easily accessible</span>
<span class="sd">            way in the specConv object.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># pass on if no lines were fit</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">dolinefit</span><span class="p">:</span>

            <span class="k">pass</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">basearr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
            <span class="n">basearr_1comp</span> <span class="o">=</span> <span class="n">basearr</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxncomp</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">basearr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">fluxerr</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">fluxpk</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">fluxpkerr</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">fluxpk_obs</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">fluxpkerr_obs</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">sigmaerr</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">sigma_obs</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">sigmaerr_obs</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">waveerr</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

            <span class="n">tf</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr_1comp</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
            <span class="n">tfe</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">basearr_1comp</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>

            <span class="c1">#   Populate Tables</span>

            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">):</span>

                    <span class="c1"># indices</span>
                    <span class="n">lmline</span> <span class="o">=</span> <span class="n">lmlabel</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="n">ifluxpk</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lmline</span><span class="o">.</span><span class="n">lmlabel</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_flx&#39;</span>
                    <span class="n">isigma</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lmline</span><span class="o">.</span><span class="n">lmlabel</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_sig&#39;</span>
                    <span class="n">iwave</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lmline</span><span class="o">.</span><span class="n">lmlabel</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_cwv&#39;</span>
                    <span class="n">ispecres</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">lmline</span><span class="o">.</span><span class="n">lmlabel</span><span class="si">}</span><span class="s1">_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_SPECRES&#39;</span>

                    <span class="c1"># make sure the line was fit -- necessary if, e.g., #</span>
                    <span class="c1"># components reset to 0 by checkcomp</span>
                    <span class="k">if</span> <span class="n">iwave</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>

                        <span class="n">wave</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">iwave</span><span class="p">]</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">isigma</span><span class="p">]</span>
                        <span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">ifluxpk</span><span class="p">]</span>

                        <span class="n">waveerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perror</span><span class="p">[</span><span class="n">iwave</span><span class="p">]</span>
                        <span class="n">sigmaerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perror</span><span class="p">[</span><span class="n">isigma</span><span class="p">]</span>
                        <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perror</span><span class="p">[</span><span class="n">ifluxpk</span><span class="p">]</span>

                        <span class="n">specres</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">ispecres</span><span class="p">]</span>

                        <span class="c1"># Check to see if line went to 0 boundary; possibly</span>
                        <span class="c1"># relevant only for leastsq. When this happens with </span>
                        <span class="c1"># leastsq, uncertainties don&#39;t get calculated and code</span>
                        <span class="c1"># to calculate observed sigma and fluxes will fail.</span>
                        <span class="c1"># Setting flux to 0 and fluxerr to 0 will allow </span>
                        <span class="c1"># checkcomp to ignore this line.</span>
                        <span class="n">zeroflux</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">parinit</span><span class="p">[</span><span class="n">ifluxpk</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">):</span>
                            <span class="n">zeroflux</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

                        <span class="c1"># Check to see if uncertainties estimated. If not, there</span>
                        <span class="c1"># was a problem in leastsq (or perhaps another fitting </span>
                        <span class="c1"># routine) and we should set flux to 0 and fluxerr to 0.</span>
                        <span class="c1"># This will allow checkcomp to ignore this line.</span>
                        <span class="n">nouncert</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">([</span><span class="n">waveerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> 
                                     <span class="n">sigmaerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> 
                                     <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]])</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                            <span class="n">nouncert</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

                        <span class="c1"># Compute observed sigma and fluxpk, taking into account</span>
                        <span class="c1"># spectral resolution.</span>
                        <span class="k">if</span> <span class="n">specres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">ignoreres</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> \
                            <span class="n">zeroflux</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="n">nouncert</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>    
                            <span class="c1"># Get spectral resolution</span>
                            <span class="n">Ruse</span> <span class="o">=</span> <span class="n">specres</span><span class="o">.</span><span class="n">get_R</span><span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                            <span class="n">sigma_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">isigma</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span>
                                        <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">Ruse</span><span class="o">/</span>
                                         <span class="n">gaussian_sigma_to_fwhm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">sigmaerr_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perror</span><span class="p">[</span><span class="n">isigma</span><span class="p">]</span> <span class="o">*</span> \
                                <span class="n">sigma_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">fluxpk_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param</span><span class="p">[</span><span class="n">ifluxpk</span><span class="p">]</span> <span class="o">*</span> \
                                <span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">sigma_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">fluxpkerr_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">perror</span><span class="p">[</span><span class="n">ifluxpk</span><span class="p">]</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">sigma_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">sigmaerr_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigmaerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">fluxpk_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">fluxpkerr_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>

                <span class="c1"># Because of the way these lines are tied to others (with a division!) they</span>
                <span class="c1"># can yield NaNs in components that aren&#39;t fit. Correct this.</span>
                <span class="c1"># if line eq &#39;[SII]6731&#39; OR line eq &#39;Hbeta&#39; OR line eq &#39;[NI]5189&#39; then begin</span>

                <span class="c1">#if (line == &#39;[SII]6731&#39;) or (line == &#39;[NI]5189&#39;):</span>
                <span class="c1">#    inan = np.where(np.isfinite(fluxpk[line]) == False)</span>
                <span class="c1">#    ctnan = np.count_nonzero(np.isfinite(fluxpk[line]) == False)</span>
                <span class="c1">#    if ctnan &gt; 0:</span>
                <span class="c1">#        fluxpk[line][inan] = 0.</span>
                <span class="c1">#        fluxpkerr[line,inan] = 0.</span>
                <span class="c1">#        fluxpk_obs[line,inan] = 0.</span>
                <span class="c1">#        fluxpkerr_obs[line,inan] = 0.</span>

            <span class="c1">#for line in self.linelist[&#39;name&#39;]:</span>

            <span class="c1"># Fix flux errors associated with line ratios. E.g., [NII]/Halpha is a fitted</span>
            <span class="c1"># parameter and [NII]6583 is tied to it, so the formal error in [NII]6583</span>
            <span class="c1"># flux is 0. Add errors in Halpha and [NII]/Halpha in quadrature to get</span>
            <span class="c1">#  error in [NII]6583.</span>

                <span class="c1"># if (line == &quot;[NII]6583&quot;) and (ctn2ha &gt; 0):</span>
                <span class="c1">#     fluxpkerr_obs[line][0:ctn2ha] = fluxpk_obs[line][0:ctn2ha] * \</span>
                <span class="c1">#     np.sqrt((perror[in2ha]/param[in2ha])**2. + \</span>
                <span class="c1">#     (fluxpkerr_obs[&#39;Halpha&#39;][0:ctn2ha]/ fluxpk_obs[&#39;Halpha&#39;][0:ctn2ha])**2.)</span>
                <span class="c1">#     # In pegged case, set errors equal to each other</span>
                <span class="c1">#     ipegged = np.where((perror[in2ha] == 0.) and (param[in2ha] != 0.))</span>
                <span class="c1">#     ctpegged = np.count_nonzero((perror[in2ha] == 0.) and (param[in2ha] != 0.))</span>
                <span class="c1">#     if ctpegged &gt; 0:</span>
                <span class="c1">#         fluxpkerr_obs[&#39;[NII]6583&#39;][ipegged] = \</span>
                <span class="c1">#         fluxpkerr_obs[&#39;Halpha&#39;][ipegged]</span>
                <span class="c1">#     fluxpkerr[line] = fluxpkerr_obs[line]</span>

                <span class="c1"># if (line == &#39;[SII]6731&#39;) and (cts2rat &gt; 0):</span>
                <span class="c1">#     fluxpkerr_obs[line][0:cts2rat] = \</span>
                <span class="c1">#     fluxpk_obs[line][0:cts2rat] * \</span>
                <span class="c1">#     np.sqrt((perror[is2rat]/param[is2rat])**2. + \</span>
                <span class="c1">#     (fluxpkerr_obs[&#39;[SII]6716&#39;][0:cts2rat] / \</span>
                <span class="c1">#     fluxpk_obs[&#39;[SII]6716&#39;][0:cts2rat])**2.)</span>
                <span class="c1">#     # In pegged case, set errors equal to each other</span>
                <span class="c1">#     ipegged = np.where((perror[is2rat] == 0.) and (param[is2rat] != 0.))</span>
                <span class="c1">#     ctpegged = np.count_nonzero((perror[in2ha] == 0.) and (param[in2ha] != 0.))</span>
                <span class="c1">#     if ctpegged &gt; 0:</span>
                <span class="c1">#         fluxpkerr_obs[&#39;[SII]6731&#39;][ipegged] = \</span>
                <span class="c1">#         fluxpkerr_obs[&#39;[SII]6716&#39;][ipegged]</span>
                <span class="c1">#     fluxpkerr[line] = fluxpkerr_obs[line]</span>

                <span class="c1"># if (line == &#39;[NI]5198&#39;) and (ctn1rat &gt; 0):</span>
                <span class="c1">#     fluxpkerr_obs[line][0:ctn1rat] = \</span>
                <span class="c1">#     fluxpk_obs[line][0:ctn1rat] * \</span>
                <span class="c1">#     np.sqrt((perror[in1rat]/param[in1rat])**2. + \</span>
                <span class="c1">#     (fluxpkerr_obs[&#39;[NI]5200&#39;][0:ctn1rat]/ \</span>
                <span class="c1">#     fluxpk_obs[&#39;[NI]5200&#39;][0:ctn1rat])**2.)</span>

                <span class="c1">#     fluxpkerr[line] = fluxpkerr_obs[line]</span>

                <span class="c1">#     # In pegged case, set errors equal to each other</span>
                <span class="c1">#     ipegged = np.where((perror[in1rat] == 0.) and (param[in1rat] != 0.))</span>
                <span class="c1">#     ctpegged = np.count_nonzero((perror[in1rat] == 0.) and (param[in1rat] != 0.))</span>
                <span class="c1">#     if ctpegged &gt; 0:</span>
                <span class="c1">#         fluxpkerr_obs[&#39;[NI]5198&#39;][ipegged] = fluxpkerr_obs[&#39;[NI]5200&#39;][ipegged]</span>

                <span class="c1">#     fluxpkerr[line] = fluxpkerr_obs[line]</span>

                <span class="c1"># if (line == &#39;Hbeta&#39;) and (np.count_nonzero(self.linelist[&#39;name&#39;] == &#39;Halpha&#39;) == 1):</span>
                <span class="c1">#     # If Halpha/Hbeta goes belowlower limit, then we re-calculate the errors</span>
                <span class="c1">#     # add discrepancy in quadrature to currently calculated error. Assume</span>
                <span class="c1">#     # error in fitting is in Hbeta and adjust accordingly.</span>
                <span class="c1">#     fha = fluxpk[&#39;Halpha&#39;]</span>
                <span class="c1">#     ihahb = np.where((fluxpk[&#39;Halpha&#39;] &gt; 0.) and (fluxpk[&#39;Hbeta&#39;] &gt; 0.))</span>
                <span class="c1">#     cthahb = np.count_nonzero((fluxpk[&#39;Halpha&#39;] &gt; 0.) and (fluxpk[&#39;Hbeta&#39;] &gt; 0.))</span>
                <span class="c1">#     if cthahb &gt; 0.:</span>
                <span class="c1">#         itoolow = np.where(fluxpk[&#39;Halpha&#39;][ihahb]/fluxpk[&#39;Hbeta&#39;] &lt; 2.86)</span>
                <span class="c1">#         cttoolow = np.count_nonzero(fluxpk[&#39;Halpha&#39;][ihahb]/fluxpk[&#39;Hbeta&#39;] &lt; 2.86)</span>
                <span class="c1">#         if cttoolow &gt; 0:</span>
                <span class="c1">#             fluxpkdiff = fluxpk[line][itoolow] - fluxpk[&#39;Halpha&#39;][itoolow]/2.86</span>
                <span class="c1">#             fluxpk[line][itoolow] -= fluxpkdiff</span>
                <span class="c1">#             fluxpk_obs[line][itoolow] -= fluxpkdiff</span>
                <span class="c1">#             fluxpkerr[line][itoolow] = np.sqrt(fluxpkerr[line][itoolow]**2. + fluxpkdiff**2.)</span>
                <span class="c1">#             fluxpkerr_obs[line][itoolow] = np.sqrt(fluxpkerr_obs[line][itoolow]**2. + fluxpkdiff**2.)</span>

                <span class="c1"># if (line == &#39;[OII]3729&#39;) and (cto2rat &gt; 0.):</span>
                <span class="c1">#     fluxpkerr_obs[line][0:cto2rat] = \</span>
                <span class="c1">#     fluxpk_obs[line][0:cto2rat]*np.sqrt( \</span>
                <span class="c1">#     (perror[io2rat]/param[io2rat])**2. + \</span>
                <span class="c1">#     (fluxpkerr_obs[&#39;[OII]3726&#39;][0:cto2rat]/ \</span>
                <span class="c1">#     fluxpk_obs[&#39;[OII]3726&#39;][0:cto2rat])**2.)</span>
                <span class="c1">#     # In pegged case, set errors equal to each other</span>
                <span class="c1">#     ipegged = np.where((perror[io2rat] == 0.) and (param[io2rat] != 0.))</span>
                <span class="c1">#     ctpegged = np.count_nonzero((perror[io2rat] == 0.) and (param[io2rat] != 0.))</span>
                <span class="c1">#     if ctpegged &gt; 0:</span>
                <span class="c1">#         fluxpkerr_obs[&#39;[OII]3729&#39;][ipegged] = fluxpkerr_obs[&#39;[OII]3726&#39;][ipegged]</span>
                <span class="c1">#     fluxpkerr[line] = fluxpkerr_obs[line]</span>

                        <span class="c1"># Add back in spectral resolution</span>

                        <span class="c1"># Make sure we&#39;re not adding something to 0 --</span>
                        <span class="c1"># i.e. the component wasn&#39;t fit.</span>
                        <span class="c1"># Can&#39;t use sigma = 0 as criterion since the line could be</span>
                        <span class="c1"># fitted but unresolved.</span>
                        <span class="k">if</span> <span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1">#sigmatmp = \</span>
                            <span class="c1">#    sigma[line][i]/(constants.c/1.e3)*wave[line][i]</span>
                            <span class="c1"># in km/s</span>
                            <span class="c1">#sigma_obs[line][i] = \</span>
                            <span class="c1">#    sigmatmp/wave[line][i]*(constants.c/1.e3)</span>
                            <span class="c1"># error propagation for adding in quadrature</span>
                            <span class="c1">#sigmaerr_obs[line][i] *= \</span>
                            <span class="c1">#    sigma[line][i]/(constants.c/1.e3)*wave[line][i] /\</span>
                            <span class="c1">#    sigmatmp</span>
                            <span class="c1"># Correct peak flux and error for deconvolution</span>
                            <span class="c1">#fluxpk[line][i] *= sigma_obs[line][i]/sigma[line][i]</span>
                            <span class="c1">#fluxpkerr[line][i] *= sigma_obs[line][i]/sigma[line][i]</span>

                            <span class="c1"># Compute total Gaussian flux</span>
                            <span class="c1"># sigma and error need to be in wavelength space</span>
                            <span class="n">gflux</span> <span class="o">=</span> \
                                <span class="n">gaussflux</span><span class="p">(</span><span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
                                          <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="mf">1.e3</span><span class="p">)</span> <span class="o">*</span> <span class="n">wave</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">normerr</span><span class="o">=</span><span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">],</span>
                                          <span class="n">sigerr</span><span class="o">=</span><span class="n">sigmaerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
                                          <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span> <span class="o">/</span> <span class="mf">1.e3</span><span class="p">)</span> <span class="o">*</span> <span class="n">wave</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">gflux</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">,</span> <span class="s1">&#39;flux_err&#39;</span><span class="p">:</span> <span class="mf">0.</span><span class="p">}</span>
                        <span class="n">flux</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gflux</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
                        <span class="n">fluxerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gflux</span><span class="p">[</span><span class="s1">&#39;flux_err&#39;</span><span class="p">]</span>

                        <span class="c1"># Set fluxes to 0 outside of wavelength range,</span>
                        <span class="c1"># or if NaNs or infinite errors</span>

                        <span class="n">inoflux_wr</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="n">waveran</span><span class="p">:</span>
                            <span class="n">inoflux_wr</span> <span class="o">=</span> \
                                <span class="p">((</span><span class="n">waveran</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">wave</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>
                                  <span class="p">(</span><span class="mf">1.</span> <span class="o">-</span> <span class="mf">3.</span><span class="o">*</span><span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
                                   <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">/</span><span class="mf">1.e3</span><span class="p">)))</span> <span class="ow">or</span>
                                 <span class="p">(</span><span class="n">waveran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">wave</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span>
                                  <span class="p">(</span><span class="mf">1.</span> <span class="o">+</span> <span class="mf">3.</span><span class="o">*</span><span class="n">sigma</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
                                   <span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">c</span><span class="o">/</span><span class="mf">1.e3</span><span class="p">))))</span>

                        <span class="n">inoflux</span> <span class="o">=</span> \
                            <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span>
                             <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">))</span>

                        <span class="k">if</span> <span class="n">inoflux_wr</span> <span class="ow">or</span> <span class="n">inoflux</span><span class="p">:</span>
                            <span class="n">flux</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxpk</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxpk_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                            <span class="n">fluxpkerr_obs</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

                <span class="c1"># Compute total fluxes summed over components</span>
                <span class="n">igd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="n">ctgd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">line</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ctgd</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">tf</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flux</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">igd</span><span class="p">])</span>
                    <span class="n">tfe</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="n">igd</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">tf</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
                    <span class="n">tfe</span><span class="p">[</span><span class="n">line</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="c1"># Special doublet cases: combine fluxes from each line</span>
            <span class="k">if</span> <span class="n">doublets</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

                <span class="k">for</span> <span class="p">(</span><span class="n">name1</span><span class="p">,</span> <span class="n">name2</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">doublets</span><span class="p">[</span><span class="s1">&#39;line1&#39;</span><span class="p">],</span>
                                          <span class="n">doublets</span><span class="p">[</span><span class="s1">&#39;line2&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">name1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">and</span> \
                        <span class="n">name2</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linelist</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]:</span>
                        <span class="c1"># new line label</span>
                        <span class="n">dkey</span> <span class="o">=</span> <span class="n">name1</span><span class="o">+</span><span class="s1">&#39;+&#39;</span><span class="o">+</span><span class="n">name2</span>
                        <span class="c1"># add fluxes</span>
                        <span class="n">tf</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">tf</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">tf</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span>
                        <span class="n">flux</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">flux</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span>
                        <span class="n">fluxpk</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxpk</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">fluxpk</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span>
                        <span class="n">fluxpk_obs</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">fluxpk_obs</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">fluxpk_obs</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span>
                        <span class="c1"># add flux errors in quadrature</span>
                        <span class="n">tfe</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">tfe</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="n">tfe</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">fluxerr</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fluxerr</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span>
                                                <span class="n">fluxerr</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fluxpkerr</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span>
                                                  <span class="n">fluxpkerr</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="n">fluxpkerr_obs</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">fluxpkerr_obs</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span>
                                                      <span class="n">fluxpkerr_obs</span><span class="p">[</span><span class="n">name2</span><span class="p">]</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
                        <span class="c1"># average waves and sigmas and errors</span>
                        <span class="n">wave</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">wave</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">wave</span><span class="p">[</span><span class="n">name2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">waveerr</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">waveerr</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">waveerr</span><span class="p">[</span><span class="n">name2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">sigma</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">sigma</span><span class="p">[</span><span class="n">name2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">sigmaerr</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmaerr</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">sigmaerr</span><span class="p">[</span><span class="n">name2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">sigma_obs</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigma_obs</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span><span class="o">+</span><span class="n">sigma_obs</span><span class="p">[</span><span class="n">name2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>
                        <span class="n">sigmaerr_obs</span><span class="p">[</span><span class="n">dkey</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">sigmaerr_obs</span><span class="p">[</span><span class="n">name1</span><span class="p">]</span> <span class="o">+</span>
                                              <span class="n">sigmaerr_obs</span><span class="p">[</span><span class="n">name2</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">line_fitpars</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="n">flux</span><span class="p">,</span> <span class="s1">&#39;fluxerr&#39;</span><span class="p">:</span> <span class="n">fluxerr</span><span class="p">,</span>
                                 <span class="s1">&#39;fluxpk&#39;</span><span class="p">:</span> <span class="n">fluxpk</span><span class="p">,</span> <span class="s1">&#39;fluxpkerr&#39;</span><span class="p">:</span> <span class="n">fluxpkerr</span><span class="p">,</span>
                                 <span class="s1">&#39;wave&#39;</span><span class="p">:</span> <span class="n">wave</span><span class="p">,</span> <span class="s1">&#39;waveerr&#39;</span><span class="p">:</span> <span class="n">waveerr</span><span class="p">,</span>
                                 <span class="s1">&#39;sigma&#39;</span><span class="p">:</span> <span class="n">sigma</span><span class="p">,</span> <span class="s1">&#39;sigmaerr&#39;</span><span class="p">:</span> <span class="n">sigmaerr</span><span class="p">,</span>
                                 <span class="s1">&#39;sigma_obs&#39;</span><span class="p">:</span> <span class="n">sigma_obs</span><span class="p">,</span>
                                 <span class="s1">&#39;sigmaerr_obs&#39;</span><span class="p">:</span> <span class="n">sigmaerr_obs</span><span class="p">,</span>
                                 <span class="s1">&#39;fluxpk_obs&#39;</span><span class="p">:</span> <span class="n">fluxpk_obs</span><span class="p">,</span>
                                 <span class="s1">&#39;fluxpkerr_obs&#39;</span><span class="p">:</span> <span class="n">fluxpkerr_obs</span><span class="p">,</span>
                                 <span class="s1">&#39;tflux&#39;</span><span class="p">:</span> <span class="n">tf</span><span class="p">,</span> <span class="s1">&#39;tfluxerr&#39;</span><span class="p">:</span> <span class="n">tfe</span><span class="p">}</span></div>


<div class="viewcode-block" id="q3dout.sepcontpars">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout.sepcontpars">[docs]</a>
    <span class="k">def</span> <span class="nf">sepcontpars</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q3di</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">q3dii</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_q3dio</span><span class="p">(</span><span class="n">q3di</span><span class="p">)</span>

        <span class="c1"># Compute PPXF components: additive polynomial and stellar fit</span>
        <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">decompose_ppxf_fit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_poly_degree</span> <span class="o">=</span> <span class="mi">4</span>  <span class="c1"># should match fitspec</span>
            <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;add_poly_degree&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>
                    <span class="n">add_poly_degree</span> <span class="o">=</span> \
                        <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;add_poly_degree&#39;</span><span class="p">]</span>
            <span class="c1"># Compute polynomial</span>
            <span class="n">dumy_log</span><span class="p">,</span> <span class="n">wave_log</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                <span class="n">log_rebin</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
            <span class="n">xnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wave_log</span><span class="p">))</span>
            <span class="n">cont_fit_poly_log</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">add_poly_degree</span><span class="p">):</span>
                <span class="n">cfpllegfun</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                <span class="n">cont_fit_poly_log</span> <span class="o">+=</span> <span class="n">cfpllegfun</span><span class="p">(</span><span class="n">xnorm</span><span class="p">)</span> <span class="o">*</span> \
                    <span class="bp">self</span><span class="o">.</span><span class="n">ct_add_poly_weights</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
            <span class="n">interpfunction</span> <span class="o">=</span> \
                <span class="n">interp1d</span><span class="p">(</span><span class="n">cont_fit_poly_log</span><span class="p">,</span> <span class="n">wave_log</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
                         <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cont_fit_poly</span> <span class="o">=</span> <span class="n">interpfunction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">))</span>
            <span class="c1"># Compute stellar continuum</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cont_fit_stel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cont_fit</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">cont_fit_poly</span><span class="p">)</span>

        <span class="c1"># Compute FITQSOHOST components</span>
        <span class="k">elif</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">decompose_qso_fit</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">polymod_refit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">),</span>
                                          <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">fcncontfit</span> <span class="o">==</span> <span class="s1">&#39;fitqsohost&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;qsoord&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>
                    <span class="n">qsoord</span> <span class="o">=</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;qsoord&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qsoord</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="k">if</span> <span class="s1">&#39;hostord&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>
                    <span class="n">hostord</span> <span class="o">=</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;hostord&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">hostord</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># copy of BLR fit parameters from argscontfit</span>
                <span class="k">if</span> <span class="s1">&#39;blrpar&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span> <span class="o">=</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;blrpar&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="c1"># default here must be same as in IFSF_FITQSOHOST</span>
                <span class="k">if</span> <span class="s1">&#39;add_poly_degree&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_poly_degree</span> <span class="o">=</span> \
                        <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;add_poly_degree&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">add_poly_degree</span> <span class="o">=</span> <span class="mi">30</span>

                <span class="c1"># Get and renormalize template</span>
                <span class="n">qsotemplate</span> <span class="o">=</span> \
                    <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;qsoxdr&#39;</span><span class="p">],</span>
                            <span class="n">allow_pickle</span><span class="o">=</span><span class="s1">&#39;TRUE&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
                <span class="n">qsowave</span> <span class="o">=</span> <span class="n">qsotemplate</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">]</span>
                <span class="n">qsoflux_full</span> <span class="o">=</span> <span class="n">qsotemplate</span><span class="p">[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>

                <span class="c1">#iqsoflux = \</span>
                <span class="c1">#    np.where((qsowave &gt;= q3dii.fitrange[0]) &amp;</span>
                <span class="c1">#             (qsowave &lt;= q3dii.fitrange[1]))</span>
                <span class="n">qsoflux</span> <span class="o">=</span> <span class="n">qsoflux_full</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fitran_indx</span><span class="p">]</span>

                <span class="c1"># If polynomial residual is re-fit with PPXF,</span>
                <span class="c1"># compute polynomial component</span>
                <span class="k">if</span> <span class="s1">&#39;refit&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span> <span class="ow">and</span> \
                    <span class="s1">&#39;args_questfit&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>

                    <span class="n">par_qsohost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span><span class="p">[</span><span class="s1">&#39;qso_host&#39;</span><span class="p">]</span>
                    <span class="c1"># par_stel = self.ct_coeff&#39;][&#39;stel&#39;]</span>
                    <span class="n">dumy_log</span><span class="p">,</span> <span class="n">wave_rebin</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> \
                        <span class="n">log_rebin</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">wave</span>
                                   <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="p">)</span>
                    <span class="n">xnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">wave_rebin</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_poly_degree</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">par_poly</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span><span class="p">[</span><span class="s1">&#39;poly&#39;</span><span class="p">]</span>
                        <span class="n">polymod_log</span> <span class="o">=</span> \
                            <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">legendre</span><span class="o">.</span><span class="n">legval</span><span class="p">(</span><span class="n">xnorm</span><span class="p">,</span> <span class="n">par_poly</span><span class="p">)</span>
                        <span class="n">interpfunct</span> <span class="o">=</span> \
                            <span class="n">interp1d</span><span class="p">(</span><span class="n">wave_rebin</span><span class="p">,</span> <span class="n">polymod_log</span><span class="p">,</span>
                                     <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">,</span>
                                     <span class="n">fill_value</span><span class="o">=</span><span class="s2">&quot;extrapolate&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">polymod_refit</span> <span class="o">=</span> \
                            <span class="n">interpfunct</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">))</span>

                <span class="c1"># Refitting with questfit in the MIR</span>
                <span class="k">elif</span> <span class="s1">&#39;refit&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span> <span class="ow">and</span> \
                    <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">[</span><span class="s1">&#39;refit&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;questfit&#39;</span><span class="p">:</span>

                    <span class="n">par_qsohost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span><span class="p">[</span><span class="s1">&#39;qso_host&#39;</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">par_qsohost</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span>

                <span class="c1"># produce fit with template only and with template + host. Also</span>
                <span class="c1"># output QSO multiplicative polynomial</span>
                <span class="c1">#qsomod_polynorm = 0.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span> <span class="o">=</span> \
                    <span class="n">qsohostfcn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="n">params_fit</span><span class="o">=</span><span class="n">par_qsohost</span><span class="p">,</span>
                               <span class="n">qsoflux</span><span class="o">=</span><span class="n">qsoflux</span><span class="p">,</span> <span class="n">qsoonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">blrpar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span><span class="p">,</span> <span class="n">qsoord</span><span class="o">=</span><span class="n">qsoord</span><span class="p">,</span>
                               <span class="n">hostord</span><span class="o">=</span><span class="n">hostord</span><span class="p">)</span>
                <span class="c1">#self.hostmod = self.cont_fit_pretweak - self.qsomod</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cont_fit</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span>

                <span class="c1"># if continuum is tweaked in any region, subide resulting residual</span>
                <span class="c1"># proportionality @ each wavelength btwn qso and host components</span>
                <span class="c1"># qsomod_notweak = qsomod</span>
                <span class="c1"># if q3dii.tweakcntfit is not None:</span>
                <span class="c1">#     modresid = self.cont_fit - self.cont_fit_pretweak</span>
                <span class="c1">#     inz = np.where((qsomod != 0) &amp; (hostmod != 0))[0]</span>
                <span class="c1">#     qsofrac = np.zeros(len(qsomod))</span>
                <span class="c1">#     for ind in inz:</span>
                <span class="c1">#         qsofrac[ind] = qsomod[ind] / \</span>
                <span class="c1">#             (qsomod[ind] + hostmod[ind])</span>
                <span class="c1">#     qsomod += modresid * qsofrac</span>
                <span class="c1">#     hostmod += modresid * (1.0 - qsofrac)</span>
                <span class="c1"># components of qso fit for plotting</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qsomod_normonly</span> <span class="o">=</span> <span class="n">qsoflux</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qsomod_blronly</span> <span class="o">=</span> \
                        <span class="n">qsohostfcn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span>
                                   <span class="n">params_fit</span><span class="o">=</span><span class="n">par_qsohost</span><span class="p">,</span>
                                   <span class="n">qsoflux</span><span class="o">=</span><span class="n">qsoflux</span><span class="p">,</span> <span class="n">blronly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                   <span class="n">blrpar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span><span class="p">,</span> <span class="n">qsoord</span><span class="o">=</span><span class="n">qsoord</span><span class="p">,</span>
                                   <span class="n">hostord</span><span class="o">=</span><span class="n">hostord</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">qsomod_blronly</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="c1"># CB: adding option to plot decomposed QSO fit if questfit is used</span>
            <span class="k">elif</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">fcncontfit</span> <span class="o">==</span> <span class="s1">&#39;questfit&#39;</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">q3dfit.contfit</span> <span class="kn">import</span> <span class="n">quest_extract_QSO_contrib</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span><span class="p">,</span> <span class="n">qsomod_intr</span><span class="p">,</span> <span class="n">hostmod_intr</span> <span class="o">=</span> \
                    <span class="n">quest_extract_QSO_contrib</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span><span class="p">,</span> <span class="n">q3dii</span><span class="p">)</span>
                <span class="c1"># qsomod_polynorm = 1.</span>
                <span class="c1"># qsomod_notweak = self.qsomod</span>
                <span class="n">qsoflux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qsomod_normonly</span> <span class="o">=</span> <span class="n">qsoflux</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qsomod_blronly</span> <span class="o">=</span> <span class="mf">0.</span></div>


        <span class="c1">#self.host_spec = self.spec - self.qsomod</span>
        <span class="c1">#self.host_cont_dat = self.cont_dat - self.qsomod</span>
        <span class="c1">#self.host_cont_fit = self.cont_fit - self.qsomod</span>

        <span class="c1">#self.qso_spec = self.spec - self.hostmod</span>
        <span class="c1">#self.qso_cont_dat = self.cont_dat - self.hostmod</span>
        <span class="c1">#self.qso_cont_fit = self.cont_fit - self.hostmod</span>

<div class="viewcode-block" id="q3dout.plot_line">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout.plot_line">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q3di</span><span class="p">,</span> <span class="n">fcn</span><span class="o">=</span><span class="s1">&#39;plotline&#39;</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">plotargs</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># if inline is False:</span>
        <span class="c1">#    mpl.use(&#39;agg&#39;)</span>

        <span class="n">q3dii</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_q3dio</span><span class="p">(</span><span class="n">q3di</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dolinefit</span><span class="p">:</span>
            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;q3dfit.plot&#39;</span><span class="p">)</span>
            <span class="n">plotline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># use default label</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;filelab&#39;</span><span class="p">):</span>
                        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelab</span><span class="o">+</span><span class="s1">&#39;_lin&#39;</span>
                    <span class="c1"># make sure an outfile is available if the default is not</span>
                    <span class="c1"># specified</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plot_line: need to specify outfile&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">outfile</span> <span class="o">=</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;_lin&#39;</span><span class="p">,</span>

            <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">spect_convol</span><span class="p">:</span>
                <span class="c1"># instantiate specConv object</span>
                <span class="n">specConv</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_dispersion</span><span class="p">(</span><span class="n">q3dii</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">specConv</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">plotline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfile</span><span class="p">,</span> <span class="n">specConv</span><span class="o">=</span><span class="n">specConv</span><span class="p">,</span>
                     <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plot_line: no lines to plot!&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="q3dout.plot_cont">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dout.q3dout.plot_cont">[docs]</a>
    <span class="k">def</span> <span class="nf">plot_cont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q3di</span><span class="p">,</span> <span class="n">fcn</span><span class="o">=</span><span class="s1">&#39;plotcont&#39;</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">plotargs</span><span class="o">=</span><span class="p">{}):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Continuum plotting function</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># if inline is False:</span>
        <span class="c1">#    mpl.use(&#39;agg&#39;)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">docontfit</span><span class="p">:</span>

            <span class="n">q3dii</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_q3dio</span><span class="p">(</span><span class="n">q3di</span><span class="p">)</span>

            <span class="n">mod</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="s1">&#39;q3dfit.plot&#39;</span><span class="p">)</span>
            <span class="n">plotcont</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mod</span><span class="p">,</span> <span class="n">fcn</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">savefig</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;filelab&#39;</span><span class="p">):</span>
                        <span class="n">outfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filelab</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plot_line: need to specify outfile&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">outfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">outfilecnt</span> <span class="o">=</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;_cnt&#39;</span><span class="p">,</span>
                <span class="n">outfileqso</span> <span class="o">=</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;_cnt_qso&#39;</span><span class="p">,</span>
                <span class="n">outfilehost</span> <span class="o">=</span> <span class="n">outfile</span> <span class="o">+</span> <span class="s1">&#39;_cnt_host&#39;</span><span class="p">,</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outfilecnt</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">outfileqso</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">outfilehost</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># Plot QSO and host only continuum fit</span>
            <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">decompose_qso_fit</span><span class="p">:</span>

                <span class="n">q3do_host</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                <span class="n">q3do_qso</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

                <span class="n">q3do_host</span><span class="o">.</span><span class="n">spec</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span>
                <span class="n">q3do_host</span><span class="o">.</span><span class="n">cont_dat</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span>
                <span class="n">q3do_host</span><span class="o">.</span><span class="n">cont_fit</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span>

                <span class="n">q3do_qso</span><span class="o">.</span><span class="n">spec</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span>
                <span class="n">q3do_qso</span><span class="o">.</span><span class="n">cont_dat</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span>
                <span class="n">q3do_qso</span><span class="o">.</span><span class="n">cont_fit</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span>

                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cont_fit</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>

                    <span class="c1"># Host only plot</span>
                    <span class="c1"># assume argscontfit exists if we&#39;re doing fitqsohost</span>
                    <span class="k">if</span> <span class="s1">&#39;refit&#39;</span> <span class="ow">in</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">argscontfit</span><span class="p">:</span>
                        <span class="n">compspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">polymod_refit</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">polymod_refit</span><span class="p">])</span>
                        <span class="n">comptitles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ord. &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_poly_degree</span><span class="p">)</span> <span class="o">+</span>
                                      <span class="s1">&#39; Leg. poly.&#39;</span><span class="p">,</span> <span class="s1">&#39;stel. temp.&#39;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">compspec</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                        <span class="n">comptitles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;exponential terms&#39;</span><span class="p">]</span>
                    <span class="n">plotcont</span><span class="p">(</span><span class="n">q3do_host</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfilehost</span><span class="p">,</span>
                             <span class="n">compspec</span><span class="o">=</span><span class="n">compspec</span><span class="p">,</span> <span class="n">comptitles</span><span class="o">=</span><span class="n">comptitles</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Host&#39;</span><span class="p">,</span> <span class="n">fitran</span><span class="o">=</span><span class="n">q3dii</span><span class="o">.</span><span class="n">fitrange</span><span class="p">,</span>
                             <span class="n">q3di</span><span class="o">=</span><span class="n">q3dii</span><span class="p">,</span> <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>

                    <span class="c1"># QSO only plot</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">blrpar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> \
                        <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod_blronly</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                        <span class="n">qsomod_blrnorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span><span class="p">)</span> <span class="o">/</span> \
                            <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod_blronly</span><span class="p">)</span>
                        <span class="n">compspec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod_normonly</span><span class="p">,</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">qsomod_blronly</span> <span class="o">*</span>
                                             <span class="n">qsomod_blrnorm</span><span class="p">])</span>
                        <span class="n">comptitles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw template&#39;</span><span class="p">,</span> <span class="s1">&#39;scattered*&#39;</span> <span class="o">+</span>
                                      <span class="nb">str</span><span class="p">(</span><span class="n">qsomod_blrnorm</span><span class="p">)]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">compspec</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod_normonly</span><span class="o">.</span><span class="n">copy</span><span class="p">()]</span>
                        <span class="n">comptitles</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;raw template&#39;</span><span class="p">]</span>

                    <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">fcncontfit</span> <span class="o">!=</span> <span class="s1">&#39;questfit&#39;</span><span class="p">:</span>
                        <span class="n">plotcont</span><span class="p">(</span><span class="n">q3do_qso</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfileqso</span><span class="p">,</span>
                                 <span class="n">compspec</span><span class="o">=</span><span class="n">compspec</span><span class="p">,</span> <span class="n">comptitles</span><span class="o">=</span><span class="n">comptitles</span><span class="p">,</span>
                                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;QSO&#39;</span><span class="p">,</span> <span class="n">fitran</span><span class="o">=</span><span class="n">q3dii</span><span class="o">.</span><span class="n">fitrange</span><span class="p">,</span>
                                 <span class="n">q3di</span><span class="o">=</span><span class="n">q3dii</span><span class="p">,</span> <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">plotcont</span><span class="p">(</span><span class="n">q3do_qso</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfileqso</span><span class="p">,</span>
                                 <span class="n">compspec</span><span class="o">=</span><span class="p">[</span><span class="n">q3do_qso</span><span class="o">.</span><span class="n">cont_fit</span><span class="p">],</span>
                                 <span class="n">title</span><span class="o">=</span><span class="s1">&#39;QSO&#39;</span><span class="p">,</span> <span class="n">fitran</span><span class="o">=</span><span class="n">q3dii</span><span class="o">.</span><span class="n">fitrange</span><span class="p">,</span>
                                 <span class="n">comptitles</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;QSO&#39;</span><span class="p">],</span> <span class="n">q3di</span><span class="o">=</span><span class="n">q3dii</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cont_fit</span><span class="p">)</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>

                <span class="k">if</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">decompose_qso_fit</span><span class="p">:</span>
                    <span class="n">plotcont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfilecnt</span><span class="p">,</span>
                             <span class="n">compspec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">qsomod</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostmod</span><span class="p">]),</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="n">comptitles</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;QSO&#39;</span><span class="p">,</span> <span class="s1">&#39;host&#39;</span><span class="p">],</span>
                             <span class="n">fitran</span><span class="o">=</span><span class="n">q3dii</span><span class="o">.</span><span class="n">fitrange</span><span class="p">,</span> <span class="n">q3di</span><span class="o">=</span><span class="n">q3dii</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">q3dii</span><span class="o">.</span><span class="n">decompose_ppxf_fit</span><span class="p">:</span>
                    <span class="n">plotcont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfilecnt</span><span class="p">,</span>
                             <span class="n">compspec</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">cont_fit_stel</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">cont_fit_poly</span><span class="p">]),</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span>
                             <span class="n">comptitles</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;stel. temp.&#39;</span><span class="p">,</span> <span class="s1">&#39;ord. &#39;</span> <span class="o">+</span>
                                         <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">add_poly_degree</span><span class="p">)</span> <span class="o">+</span>
                                         <span class="s1">&#39;Leg.poly&#39;</span><span class="p">],</span>
                             <span class="n">fitran</span><span class="o">=</span><span class="n">q3dii</span><span class="o">.</span><span class="n">fitrange</span><span class="p">,</span> <span class="n">q3di</span><span class="o">=</span><span class="n">q3dii</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plotcont</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">savefig</span><span class="o">=</span><span class="n">savefig</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="n">outfilecnt</span><span class="p">,</span>
                             <span class="n">fitran</span><span class="o">=</span><span class="n">q3dii</span><span class="o">.</span><span class="n">fitrange</span><span class="p">,</span>
                             <span class="n">q3di</span><span class="o">=</span><span class="n">q3dii</span><span class="p">,</span>
                             <span class="n">ct_coeff</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ct_coeff</span><span class="p">,</span>
                             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">plotargs</span><span class="p">)</span>

                <span class="c1"># Plot continuum</span>
                <span class="c1"># Make sure fit doesn&#39;t indicate no continuum; avoids</span>
                <span class="c1"># plot range error in continuum fitting routine,</span>
                <span class="c1"># as well as a blank plot!</span>
                <span class="c1"># if not noplots and q3dii.argscontfit is not None:</span>
                <span class="c1">#     if &#39;plot_decomp&#39; in q3dii.argscontfit&#39;].keys():</span>
                <span class="c1">#         if q3dii.argscontfit&#39;][&#39;plot_decomp&#39;]:</span>
                <span class="c1">#             from q3dfit.plot_quest import plot_quest</span>
                <span class="c1">#             if not q3do.noemlinfit&#39;]:</span>
                <span class="c1">#                 lam_lines = \</span>
                <span class="c1">#                     q3do.linelist&#39;][&#39;lines&#39;].tolist()</span>
                <span class="c1">#             else:</span>
                <span class="c1">#                 lam_lines = []</span>
                <span class="c1">#             plot_quest(q3do.wave&#39;],</span>
                <span class="c1">#                        q3do.cont_dat&#39;]+q3do.emlin_dat&#39;],</span>
                <span class="c1">#                        q3do.cont_fit&#39;]+q3do.emlin_fit&#39;],</span>
                <span class="c1">#                        q3do.ct_coeff&#39;], q3dii,</span>
                <span class="c1">#                        lines=lam_lines,</span>
                <span class="c1">#                        linespec=q3do.emlin_fit&#39;])</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;plot_cont: no continuum to plot!&#39;</span><span class="p">)</span></div>
</div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, David Rupke and the Q3D Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>