<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>q3dfit.q3dpro &mdash; q3dfit 1.1.4 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=92fd9be5" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=00f267c6"></script>
        <script src="../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            q3dfit
          </a>
              <div class="version">
                1.1.4
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">q3dfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fitting.html">Fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../MIR-configuration.html">MIR Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html">checkcomp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.contfit">contfit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.cube_bin">cube_bin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.exceptions">q3dfit.exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.fitloop">q3dfit.fitloop</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.fitspec">q3dfit.fitspec</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.gdtemp">q3dfit.gdtemp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.interp_temp_quest">q3dfit.interp_temp_quest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.interptemp">q3dfit.interptemp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.jnb">q3dfit.jnb</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.jwstlinez">q3dfit.jwstlinez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.lineinit">q3dfit.lineinit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.linelist">q3dfit.linelist</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.masklin">q3dfit.masklin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#q3dfit-mk-npy-templ">q3dfit.mk_npy_templ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.nonJWST_datacube_converter">q3dfit.nonJWST_datacube_converter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.observedlinez">q3dfit.observedlinez</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.plot">q3dfit.plot</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#q3dfit-psf-sub">q3dfit.psf_sub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dcollect">q3dfit.q3dcollect</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3df">q3dfit.q3df</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3df_helperFunctions">q3dfit.q3df_helperFunctions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3din">q3dfit.q3din</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dmath">q3dfit.q3dmath</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dout">q3dfit.q3dout</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dpro">q3dfit.q3dpro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.q3dutil">q3dfit.q3dutil</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.qsohostfcn">q3dfit.qsohostfcn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.questfitfcn">q3dfit.questfitfcn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.readcube">q3dfit.readcube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.readtemp">q3dfit.readtemp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.rebin">q3dfit.rebin</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.restline">q3dfit.restline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#q3dfit-sdi">q3dfit.sdi</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.select_spaxels">q3dfit.select_spaxels</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.spectConvol">q3dfit.spectConvol</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit.writeout_quest">q3dfit.writeout_quest</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../source/q3dfit.html#module-q3dfit">Module contents</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">q3dfit</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">q3dfit.q3dpro</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for q3dfit.q3dpro</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Created on Tue May 31 15:31:13 2022</span>

<span class="sd">@author: yuyuzo12</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">q3dfit.q3dutil</span> <span class="k">as</span> <span class="nn">q3dutil</span>

<span class="kn">from</span> <span class="nn">astropy.constants</span> <span class="kn">import</span> <span class="n">c</span>
<span class="kn">from</span> <span class="nn">astropy.cosmology</span> <span class="kn">import</span> <span class="n">WMAP9</span> <span class="k">as</span> <span class="n">cosmo</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MaxNLocator</span><span class="p">,</span> <span class="n">LinearLocator</span>
<span class="kn">from</span> <span class="nn">mpl_toolkits.axes_grid1</span> <span class="kn">import</span> <span class="n">make_axes_locatable</span>
<span class="kn">from</span> <span class="nn">q3dfit.q3dmath</span> <span class="kn">import</span> <span class="n">cmpcvdf</span>
<span class="kn">from</span> <span class="nn">q3dfit.linelist</span> <span class="kn">import</span> <span class="n">linelist</span>

<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;font.family&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;serif&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s2">&quot;mathtext.fontset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;dejavuserif&quot;</span>
<span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;figure.constrained_layout.use&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="Q3Dpro">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro">[docs]</a>
<span class="k">class</span> <span class="nc">Q3Dpro</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Class to process the q3dfit output data</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    q3dinit : object</span>
<span class="sd">        q3dinit object. Added/updated by :method:init.</span>
<span class="sd">    target_name : str</span>
<span class="sd">        Label from q3dinit. Added/updated by :method:init.</span>
<span class="sd">    silent : bool</span>
<span class="sd">        Flag to suppress print statements. Default is True. </span>
<span class="sd">        Added/updated by :method:init.</span>
<span class="sd">    pix : float</span>
<span class="sd">        Plate scale of the data. Added/updated by :method:init.</span>
<span class="sd">    bad : float</span>
<span class="sd">        Value for bad data. Default is np.nan. Added/updated by :method:init.</span>
<span class="sd">    dataDIR : str</span>
<span class="sd">        Directory of the data, from q3dinit. Added/updated by :method:init.</span>
<span class="sd">    contdat : object</span>
<span class="sd">        Continuum data object. Added/updated by :method:init, using </span>
<span class="sd">        :class:ContData.</span>
<span class="sd">    linedat : object</span>
<span class="sd">        Emission line data object. Added/updated by :method:init, using </span>
<span class="sd">        :class:LineData.</span>
<span class="sd">    map_bkg : str</span>
<span class="sd">        Background color for the maps. Default is &#39;white&#39;. Added/updated by </span>
<span class="sd">        :method:init.</span>
<span class="sd">    zsys_gas : float</span>
<span class="sd">        Systemic redshift of the galaxy. Added/updated by :method:init.</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    get_lineprop(LINESELECT)</span>
<span class="sd">        Get the wavelength and line label of an emission line.</span>
<span class="sd">    get_linemap(LINESELECT, APPLYMASK=True, SAVEDATA=False)</span>
<span class="sd">    make_linemap(LINESELECT, SNRCUT=5., xyCenter=None, </span>
<span class="sd">        VMINMAX=None, XYSTYLE=None, PLTNUM=1, CMAP=None, VCOMP=None, </span>
<span class="sd">        SAVEDATA=False)</span>
<span class="sd">    make_lineratio_map(lineA, lineB, SNRCUT=3, SAVEDATA=False, </span>
<span class="sd">        PLTNUM=5, KPC=False, VMINMAX=[-1,1])</span>
<span class="sd">    make_BPT(SNRCUT=3, SAVEDATA=False, PLTNUM=5, KPC=False)</span>
<span class="sd">    resort_line_components(dataOUT, NCOMP=None, COMP_SORT=None)</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q3di</span><span class="p">,</span> <span class="n">SILENT</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">NOCONT</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">NOLINE</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">PLATESCALE</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">BACKGROUND</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">BAD</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
                 <span class="n">zsys_gas</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Initialize the Q3Dpro object.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        See class attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># read in the q3di file and unpack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span> <span class="o">=</span> <span class="n">q3dutil</span><span class="o">.</span><span class="n">get_q3dio</span><span class="p">(</span><span class="n">q3di</span><span class="p">)</span>
        <span class="c1"># unpack initproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="o">=</span> <span class="n">SILENT</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processing outputs...&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Target name:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pix</span> <span class="o">=</span> <span class="n">PLATESCALE</span>  <span class="c1"># pixel size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad</span> <span class="o">=</span> <span class="n">BAD</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">outdir</span>
        <span class="c1"># instantiate the Continuum (npy) and Emission Line (npz) objects</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NOCONT</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">contdat</span> <span class="o">=</span> <span class="n">ContData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">NOLINE</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span> <span class="o">=</span> <span class="n">LineData</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">map_bkg</span> <span class="o">=</span> <span class="n">BACKGROUND</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">zsys_gas</span> <span class="o">=</span> <span class="n">zsys_gas</span>

        <span class="k">return</span>


<div class="viewcode-block" id="Q3Dpro.get_zsys_gas">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.get_zsys_gas">[docs]</a>
    <span class="k">def</span> <span class="nf">get_zsys_gas</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the systemic redshift of the galaxy from the zsys_gas attribute</span>
<span class="sd">        or q3dinit object, in that order.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        redshift : float</span>
<span class="sd">            Systemic redshift of the galaxy.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">zsys_gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">zsys_gas</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Redshift not set in q3dinit or q3dpro &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;objects. Please use zsys_gas parameter &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;in q3dpro to set the systemic redshift &#39;</span> <span class="o">+</span>
                                 <span class="s1">&#39;of the galaxy for computing line properties.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">zsys_gas</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zsys_gas</span>
        <span class="k">return</span> <span class="n">redshift</span></div>

    

<div class="viewcode-block" id="Q3Dpro.get_lineprop">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.get_lineprop">[docs]</a>
    <span class="k">def</span> <span class="nf">get_lineprop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LINESELECT</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Get the wavelength and line label of an emission line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        LINESELECT : str</span>
<span class="sd">            Name of the line to select.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        linewave : float</span>
<span class="sd">            Wavelength of the line in microns.</span>
<span class="sd">        linename : str</span>
<span class="sd">            Label of the line.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">listlines</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">lines</span><span class="p">,</span> <span class="n">vacuum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">vacuum</span><span class="p">)</span>
        <span class="n">ww</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">listlines</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">LINESELECT</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">linewave</span> <span class="o">=</span> <span class="n">listlines</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">][</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">linename</span> <span class="o">=</span> <span class="n">listlines</span><span class="p">[</span><span class="s1">&#39;linelab&#39;</span><span class="p">][</span><span class="n">ww</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># output in MICRON</span>
        <span class="k">return</span> <span class="n">linewave</span><span class="p">,</span> <span class="n">linename</span></div>


<div class="viewcode-block" id="Q3Dpro.get_linemap">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.get_linemap">[docs]</a>
    <span class="k">def</span> <span class="nf">get_linemap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LINESELECT</span><span class="p">,</span> <span class="n">APPLYMASK</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">SAVEDATA</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create maps of properties of an emission line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        LINESELECT : str</span>
<span class="sd">            Name of the line for which to create maps.</span>
<span class="sd">        </span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;getting line data...&#39;</span><span class="p">,</span><span class="n">LINESELECT</span><span class="p">)</span>

        <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zsys_gas</span><span class="p">()</span>
        <span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">ncomp</span><span class="p">[</span><span class="n">LINESELECT</span><span class="p">])</span>

        <span class="c1"># kpc_arcsec = cosmo.kpc_proper_per_arcmin(redshift).value/60.</span>
        <span class="c1"># arckpc = cosmo.kpc_proper_per_arcmin(redshift).value/60.</span>
        <span class="c1"># argscheckcomp = self.q3dinit.argscheckcomp</span>
        <span class="c1"># xycen = xyCenter # (nx,ny) of the center</span>

        <span class="c1"># cid = -1 # index of the component to plot, -1 is the broadest component</span>
        <span class="c1"># central wavelength --&gt; need to get from linereader</span>
        <span class="n">wave0</span><span class="p">,</span><span class="n">linetext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_lineprop</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">)</span>

        <span class="n">fluxsum</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_flux</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">FLUXSEL</span><span class="o">=</span><span class="s1">&#39;ftot&#39;</span><span class="p">)[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
        <span class="n">fluxsum_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_flux</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">FLUXSEL</span><span class="o">=</span><span class="s1">&#39;ftot&#39;</span><span class="p">)[</span><span class="s1">&#39;fluxerr&#39;</span><span class="p">]</span>
        <span class="n">fsmsk</span> <span class="o">=</span> <span class="n">clean_mask</span><span class="p">(</span><span class="n">fluxsum</span><span class="p">,</span> <span class="n">BAD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bad</span><span class="p">)</span>

        <span class="n">matrix_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">fluxsum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fluxsum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ncomp</span><span class="p">)</span>

        <span class="n">dataOUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">fluxsum</span><span class="p">,</span>
                           <span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="n">fluxsum_err</span><span class="p">,</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">:[</span><span class="s1">&#39;F$_</span><span class="si">{tot}</span><span class="s1">$&#39;</span><span class="p">],</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="n">fsmsk</span><span class="p">},</span>
                   <span class="s1">&#39;Fci&#39;</span> <span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;name&#39;</span><span class="p">:[],</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">)},</span>
                   <span class="s1">&#39;Sig&#39;</span> <span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;name&#39;</span><span class="p">:[],</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">)},</span>
                   <span class="s1">&#39;v50&#39;</span> <span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;name&#39;</span><span class="p">:[],</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">)},</span>
                   <span class="s1">&#39;w80&#39;</span> <span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">),</span><span class="s1">&#39;name&#39;</span><span class="p">:[],</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">)}}</span>

        <span class="c1"># EXTRACT COMPONENTS</span>
        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">ici</span> <span class="o">=</span> <span class="n">ci</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">fcl</span> <span class="o">=</span> <span class="s1">&#39;fc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span>
            <span class="n">iflux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_flux</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">FLUXSEL</span><span class="o">=</span><span class="n">fcl</span><span class="p">)[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
            <span class="n">ifler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_flux</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">FLUXSEL</span><span class="o">=</span><span class="n">fcl</span><span class="p">)[</span><span class="s1">&#39;fluxerr&#39;</span><span class="p">]</span>
            <span class="n">isigm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_sigma</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">COMPSEL</span><span class="o">=</span><span class="n">ici</span><span class="p">)[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span>
            <span class="n">isger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_sigma</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">COMPSEL</span><span class="o">=</span><span class="n">ici</span><span class="p">)[</span><span class="s1">&#39;sigerr&#39;</span><span class="p">]</span>
            <span class="n">iwvcn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_wave</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">COMPSEL</span><span class="o">=</span><span class="n">ici</span><span class="p">)[</span><span class="s1">&#39;wav&#39;</span><span class="p">]</span>
            <span class="n">iwver</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">get_wave</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span><span class="n">COMPSEL</span><span class="o">=</span><span class="n">ici</span><span class="p">)[</span><span class="s1">&#39;waverr&#39;</span><span class="p">]</span>
            <span class="c1">#ireds = redshift[:,:,ci]</span>

            <span class="c1"># now process them</span>
            <span class="n">iv50</span> <span class="o">=</span> <span class="p">((</span><span class="n">iwvcn</span> <span class="o">-</span> <span class="n">wave0</span><span class="p">)</span><span class="o">/</span><span class="n">wave0</span> <span class="o">-</span> <span class="n">redshift</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">1.</span><span class="o">+</span><span class="n">redshift</span><span class="p">)</span><span class="o">*</span><span class="n">c</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;km/s&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
            <span class="n">iw80</span>  <span class="o">=</span> <span class="n">isigm</span><span class="o">*</span><span class="mf">2.563</span> <span class="c1">#w80 linewidth from the velocity dispersion</span>
            <span class="c1"># mask out the bad values</span>
            <span class="n">ifmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clean_mask</span><span class="p">(</span><span class="n">iflux</span><span class="p">,</span><span class="n">BAD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bad</span><span class="p">))</span>
            <span class="n">isgmsk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clean_mask</span><span class="p">(</span><span class="n">isigm</span><span class="p">,</span><span class="n">BAD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bad</span><span class="p">))</span>
            <span class="n">iwvmsk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clean_mask</span><span class="p">(</span><span class="n">iwvcn</span><span class="p">,</span><span class="n">BAD</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bad</span><span class="p">))</span>

            <span class="c1"># save to the processed matrices</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">iflux</span><span class="c1">#*ifmask</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">isigm</span><span class="c1">#*isgmsk</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">iv50</span><span class="c1">#*iwvmsk</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">iw80</span><span class="c1">#*isgmsk</span>

            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>  <span class="o">=</span> <span class="n">ifler</span><span class="c1">#*ifmask</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>  <span class="o">=</span> <span class="n">isger</span><span class="c1">#*isgmsk</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>  <span class="o">=</span> <span class="n">iwver</span><span class="c1">#*ifmask</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>  <span class="o">=</span> <span class="n">isger</span><span class="c1">#*isgmsk</span>

            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;F$_{c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$\sigma_{c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;v$_{50,c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;w$_{80,c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>

            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">ifmask</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">isgmsk</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">iwvmsk</span>
            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">isgmsk</span>

        <span class="k">if</span> <span class="n">APPLYMASK</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ditem</span> <span class="ow">in</span> <span class="n">dataOUT</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                        <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span><span class="o">*</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>
                        <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span><span class="o">*</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                    <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">wave0</span><span class="p">,</span><span class="n">linetext</span><span class="p">,</span><span class="n">dataOUT</span></div>


<div class="viewcode-block" id="Q3Dpro.make_linemap">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.make_linemap">[docs]</a>
    <span class="k">def</span> <span class="nf">make_linemap</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">LINESELECT</span><span class="p">,</span> <span class="n">SNRCUT</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                     <span class="n">xyCenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">VMINMAX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">XYSTYLE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PLTNUM</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">CMAP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">VCOMP</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">SAVEDATA</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Create maps of properties of an emission line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        LINESELECT : str</span>
<span class="sd">            Name of the line for which to create maps.</span>
<span class="sd">        SNRCUT : float</span>
<span class="sd">            SNR cut for the data. Default is 5.</span>
<span class="sd">        xyCenter : list</span>
<span class="sd">            Center of the map. Default is None.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Plotting emission line maps&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">silent</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;create linemap:&#39;</span><span class="p">,</span> <span class="n">LINESELECT</span><span class="p">)</span>

        <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zsys_gas</span><span class="p">()</span>
        <span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">ncomp</span><span class="p">[</span><span class="n">LINESELECT</span><span class="p">])</span>

        <span class="n">kpc_arcsec</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">60.</span>
        <span class="c1"># arckpc = cosmo.kpc_proper_per_arcmin(redshift).value/60.</span>
        <span class="c1"># argscheckcomp = self.q3dinit.argscheckcomp</span>
        <span class="c1"># xycen = xyCenter # (nx,ny) of the center</span>

        <span class="c1"># cid = -1 # index of the component to plot, -1 is the broadest component</span>
        <span class="c1"># central wavelength --&gt; need to get from linereader</span>
        <span class="c1"># wave0,linetext = self.get_lineprop(LINESELECT)</span>

        <span class="c1"># --------------------------</span>
        <span class="c1"># EXTRACT THE DATA HERE</span>
        <span class="c1"># --------------------------</span>
        <span class="n">wave0</span><span class="p">,</span> <span class="n">linetext</span><span class="p">,</span> <span class="n">dataOUT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_linemap</span><span class="p">(</span><span class="n">LINESELECT</span><span class="p">,</span> <span class="n">APPLYMASK</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">dataOUT</span><span class="p">,</span> <span class="n">ncomp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resort_line_components</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">,</span> <span class="n">NCOMP</span><span class="o">=</span><span class="n">ncomp</span><span class="p">,</span> 
                                                     <span class="n">COMP_SORT</span><span class="o">=</span><span class="n">VCOMP</span><span class="p">)</span>
        <span class="c1"># EXTRACT TOTAL FLUX</span>
        <span class="c1"># sn_tot = fluxsum/fluxsum_err</span>
        <span class="c1"># w80 = sigma*2.563   # w80 linewidth from the velocity dispersion</span>
        <span class="c1"># sn = flux/flux_err</span>
        <span class="n">fluxsum</span>     <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
        <span class="n">fluxsum_err</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">]</span>

        <span class="n">fluxsum_snc</span><span class="p">,</span> <span class="n">gdindx</span><span class="p">,</span> <span class="n">bdindx</span> <span class="o">=</span> <span class="n">snr_cut</span><span class="p">(</span><span class="n">fluxsum</span><span class="p">,</span> <span class="n">fluxsum_err</span><span class="p">,</span> 
                                              <span class="n">SNRCUT</span><span class="o">=</span><span class="n">SNRCUT</span><span class="p">)</span>
        <span class="n">matrix_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">fluxsum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">fluxsum</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ncomp</span><span class="p">)</span>
        <span class="n">FLUXLOG</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># --------------------------</span>
        <span class="c1"># Do the plotting here</span>
        <span class="c1"># --------------------------</span>
        <span class="c1"># pixkpc = self.pix*arckpc</span>
        <span class="c1"># Here, we determine the plot axis</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xcol</span> <span class="o">=</span> <span class="n">xgrid</span>
        <span class="n">ycol</span> <span class="o">=</span> <span class="n">ygrid</span>

        <span class="n">qsoCenter</span> <span class="o">=</span> <span class="n">xyCenter</span>
        <span class="k">if</span> <span class="n">xyCenter</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">qsoCenter</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span>
                         <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">matrix_size</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span>

        <span class="n">XYtitle</span> <span class="o">=</span> <span class="s1">&#39;Spaxel&#39;</span>
        <span class="k">if</span> <span class="n">XYSTYLE</span> <span class="o">!=</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">XYSTYLE</span> <span class="o">!=</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1">#if XYSTYLE.lower() == &#39;center&#39;:</span>
            <span class="n">xcol</span> <span class="o">=</span> <span class="p">(</span><span class="n">xgrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ycol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ygrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">xyCenter</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">qsoCenter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">XYSTYLE</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;kpc&#39;</span><span class="p">:</span>
                <span class="n">kpc_pix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">kpc_arcsec</span><span class="p">)</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix</span>
                <span class="n">xcolkpc</span> <span class="o">=</span> <span class="n">xcol</span><span class="o">*</span><span class="n">kpc_pix</span>
                <span class="n">ycolkpc</span> <span class="o">=</span> <span class="n">ycol</span><span class="o">*</span><span class="n">kpc_pix</span>
                <span class="n">xcol</span><span class="p">,</span><span class="n">ycol</span> <span class="o">=</span> <span class="n">xcolkpc</span><span class="p">,</span> <span class="n">ycolkpc</span>
                <span class="n">XYtitle</span> <span class="o">=</span> <span class="s1">&#39;Relative distance [kpc]&#39;</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">PLTNUM</span><span class="p">)</span>
        <span class="n">figDIM</span> <span class="o">=</span> <span class="p">[</span><span class="n">ncomp</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span>
        <span class="n">figOUT</span> <span class="o">=</span> <span class="n">set_figSize</span><span class="p">(</span><span class="n">figDIM</span><span class="p">,</span> <span class="n">matrix_size</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figDIM</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figDIM</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># (12)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (14)</span>
        <span class="k">if</span> <span class="n">CMAP</span> <span class="o">==</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="n">CMAP</span> <span class="o">=</span> <span class="s1">&#39;YlOrBr_r&#39;</span>
        <span class="n">ici</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>
        <span class="k">for</span> <span class="n">icomp</span><span class="p">,</span> <span class="n">ipdat</span> <span class="ow">in</span> <span class="n">dataOUT</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">doPLT</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">pixVals</span> <span class="o">=</span> <span class="n">ipdat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="n">ipshape</span> <span class="o">=</span> <span class="n">pixVals</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">if</span> <span class="n">VMINMAX</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">vminmax</span> <span class="o">=</span> <span class="n">VMINMAX</span><span class="p">[</span><span class="n">icomp</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">icomp</span> <span class="o">==</span> <span class="s1">&#39;Ftot&#39;</span><span class="p">:</span>
                <span class="n">NTICKS</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="n">ici</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
                <span class="n">vticks</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span> <span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="s1">&#39;fluxlog&#39;</span> <span class="ow">in</span> <span class="n">VMINMAX</span> <span class="p">:</span>
                    <span class="n">FLUXLOG</span> <span class="o">=</span> <span class="n">VMINMAX</span><span class="p">[</span><span class="s1">&#39;fluxlog&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span><span class="o">=</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">icomp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;fci&#39;</span> <span class="p">:</span>
                    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">NTICKS</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="n">vticks</span> <span class="o">=</span> \
                        <span class="p">[</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])])),</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="s1">&#39;fluxlog&#39;</span> <span class="ow">in</span> <span class="n">VMINMAX</span> <span class="p">:</span>
                        <span class="n">FLUXLOG</span> <span class="o">=</span> <span class="n">VMINMAX</span><span class="p">[</span><span class="s1">&#39;fluxlog&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">icomp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;sig&#39;</span><span class="p">:</span>
                    <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">CMAP</span> <span class="o">=</span> <span class="s1">&#39;YlOrBr_r&#39;</span>
                    <span class="n">NTICKS</span>  <span class="o">=</span> <span class="mi">3</span>
                    <span class="n">vticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">FLUXLOG</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">icomp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;v50&#39;</span> <span class="p">:</span>
                    <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">NTICKS</span> <span class="o">=</span> <span class="mi">5</span>
                    <span class="n">vticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">CMAP</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span>
                    <span class="n">CMAP</span> <span class="o">+=</span> <span class="s1">&#39;_r&#39;</span>
                    <span class="n">FLUXLOG</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">icomp</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;w80&#39;</span> <span class="p">:</span>
                    <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
                    <span class="n">NTICKS</span> <span class="o">=</span> <span class="mi">3</span>
                    <span class="n">vticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],(</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                    <span class="n">CMAP</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu&#39;</span>
                    <span class="n">CMAP</span> <span class="o">+=</span> <span class="s1">&#39;_r&#39;</span>
                    <span class="n">FLUXLOG</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">doPLT</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">delaxes</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">)</span> <span class="p">:</span>
                <span class="n">ipixVals</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">icomp</span> <span class="o">!=</span> <span class="s1">&#39;Ftot&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ipshape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">doPLT</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">i</span> <span class="o">=</span> <span class="n">ci</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">ici</span> <span class="o">=</span> <span class="s1">&#39;_c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ci</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">ipixVals</span> <span class="o">=</span> <span class="n">pixVals</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">icomp</span> <span class="o">==</span> <span class="s1">&#39;Ftot&#39;</span><span class="p">:</span>
                    <span class="n">doPLT</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">ci</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                        <span class="n">doPLT</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ipixVals</span> <span class="o">=</span> <span class="n">pixVals</span>
                <span class="k">if</span> <span class="n">doPLT</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">cmap_r</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">CMAP</span><span class="p">)</span>
                    <span class="c1"># cmap_r.set_bad(color=&#39;black&#39;)</span>
                    <span class="n">cmap_r</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_bkg</span><span class="p">)</span>
                    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">xcol</span><span class="p">,</span><span class="n">ycol</span>
                    <span class="n">axi</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ncomp</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">axi</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">axi</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">display_pixels_wz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">ipixVals</span><span class="p">,</span> <span class="n">CMAP</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="n">axi</span><span class="p">,</span>
                                      <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">PLOTLOG</span><span class="o">=</span><span class="n">FLUXLOG</span><span class="p">,</span>
                                      <span class="n">VMIN</span><span class="o">=</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VMAX</span><span class="o">=</span><span class="n">vminmax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">TICKS</span><span class="o">=</span><span class="n">vticks</span><span class="p">,</span> <span class="n">NTICKS</span><span class="o">=</span><span class="n">NTICKS</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">xyCenter</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                        <span class="n">axi</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">qsoCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">qsoCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">axi</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">XYtitle</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">axi</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">XYtitle</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">axi</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">ipdat</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">][</span><span class="n">ci</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                    <span class="c1"># axi.set_ylim([min(xx),np.ceil(max(xx))])</span>
                    <span class="c1"># axi.set_xlim([min(yy),np.ceil(max(yy))])</span>
                    <span class="k">if</span> <span class="n">SAVEDATA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">linesave_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">LINESELECT</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">icomp</span><span class="o">+</span><span class="n">ici</span><span class="o">+</span><span class="s1">&#39;_map.fits&#39;</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving line map:&#39;</span><span class="p">,</span><span class="n">linesave_name</span><span class="p">)</span>
                        <span class="n">savepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span><span class="n">linesave_name</span><span class="p">)</span>
                        <span class="n">save_to_fits</span><span class="p">(</span><span class="n">pixVals</span><span class="p">,[],</span><span class="n">savepath</span><span class="p">)</span>


            <span class="c1"># j+=1</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_name</span><span class="o">+</span><span class="s1">&#39; : &#39;</span><span class="o">+</span><span class="n">linetext</span><span class="o">+</span><span class="s1">&#39; maps&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">snap</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                     <span class="c1"># verticalalignment=&#39;center&#39;,</span>
                     <span class="c1"># fontweight=&#39;semibold&#39;)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span><span class="c1">#pad=0.15,h_pad=0.1)</span>
        <span class="k">if</span> <span class="n">SAVEDATA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pltsave_name</span> <span class="o">=</span> <span class="n">LINESELECT</span><span class="o">+</span><span class="s1">&#39;_emlin_map&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving figure:&#39;</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span><span class="n">pltsave_name</span><span class="o">+</span><span class="s1">&#39;.png&#39;</span><span class="p">),</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span><span class="n">pltsave_name</span><span class="o">+</span><span class="s1">&#39;.pdf&#39;</span><span class="p">),</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">)</span>
        <span class="c1"># fig.subplots_adjust(top=0.88)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span></div>


    <span class="c1"># def make_contmap(self):</span>
    <span class="c1">#     return</span>

<div class="viewcode-block" id="Q3Dpro.make_lineratio_map">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.make_lineratio_map">[docs]</a>
    <span class="k">def</span> <span class="nf">make_lineratio_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineA</span><span class="p">,</span> <span class="n">lineB</span><span class="p">,</span> <span class="n">SNRCUT</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">SAVEDATA</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                           <span class="n">PLTNUM</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">KPC</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">VMINMAX</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]):</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># first identify the lines, extract fluxes, and apply the SNR cuts</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="n">linelist</span> <span class="o">=</span> <span class="p">{</span><span class="n">lineA</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="n">lineB</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

        <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zsys_gas</span><span class="p">()</span>

        <span class="n">arckpc</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">60.</span>
        <span class="n">mshaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">li</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">linelist</span><span class="p">:</span>
                <span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">ncomp</span><span class="p">[</span><span class="n">lin</span><span class="p">])</span>
                <span class="c1"># fluxsum     = self.linedat.get_flux(lin,FLUXSEL=&#39;ftot&#39;)[&#39;flux&#39;]</span>
                <span class="c1"># fluxsum_err = self.linedat.get_flux(lin,FLUXSEL=&#39;ftot&#39;)[&#39;fluxerr&#39;]</span>
                <span class="n">wave0</span><span class="p">,</span> <span class="n">linetext</span><span class="p">,</span> <span class="n">dataOUT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_linemap</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span> <span class="n">APPLYMASK</span><span class="o">=</span><span class="p">{})</span>
                <span class="n">istruct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wavcen&#39;</span><span class="p">:</span><span class="n">wave0</span><span class="p">,</span><span class="s1">&#39;wname&#39;</span><span class="p">:</span><span class="n">linetext</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">dataOUT</span><span class="p">,</span><span class="s1">&#39;snr&#39;</span><span class="p">:{}}</span>
                <span class="k">for</span> <span class="n">ditem</span> <span class="ow">in</span> <span class="n">dataOUT</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],[],[]]</span>
                        <span class="k">if</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                            <span class="n">i_snc</span><span class="p">,</span><span class="n">i_gindx</span><span class="p">,</span><span class="n">i_bindx</span> <span class="o">=</span> <span class="n">snr_cut</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">],</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">],</span><span class="n">SNRCUT</span><span class="o">=</span><span class="n">SNRCUT</span><span class="p">)</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">0</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_snc</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_gindx</span><span class="p">)</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_bindx</span><span class="p">)</span>
                        <span class="n">li</span><span class="o">+=</span><span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mshaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">i_snc</span><span class="p">,</span><span class="n">i_gindx</span><span class="p">,</span><span class="n">i_bindx</span> <span class="o">=</span> <span class="n">snr_cut</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">SNRCUT</span><span class="o">=</span><span class="n">SNRCUT</span><span class="p">)</span>
                        <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_snc</span><span class="p">,</span><span class="n">i_gindx</span><span class="p">,</span><span class="n">i_bindx</span><span class="p">]</span>
                <span class="n">linelist</span><span class="p">[</span><span class="n">lin</span><span class="p">]</span> <span class="o">=</span> <span class="n">istruct</span>

        <span class="n">lineratios</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;dothis&#39;</span><span class="p">:{</span><span class="s1">&#39;lines&#39;</span><span class="p">:[</span><span class="n">lineA</span><span class="p">,</span><span class="n">lineB</span><span class="p">],</span><span class="s1">&#39;pltname&#39;</span><span class="p">:</span><span class="n">linelist</span><span class="p">[</span><span class="n">lineA</span><span class="p">][</span><span class="s1">&#39;wname&#39;</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">linelist</span><span class="p">[</span><span class="n">lineB</span><span class="p">][</span><span class="s1">&#39;wname&#39;</span><span class="p">],</span><span class="s1">&#39;lrat&#39;</span><span class="p">:{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}}</span>

        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># Calculate the line ratios</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calculating line ratios...&#39;</span><span class="p">)</span>
        <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lrat</span><span class="p">,</span><span class="n">lratdat</span> <span class="ow">in</span> <span class="n">lineratios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f1tot</span><span class="p">,</span><span class="n">f1tot_err</span><span class="p">,</span><span class="n">m1tot</span><span class="p">,</span><span class="n">f1scntot</span><span class="p">,</span><span class="n">f1ci</span><span class="p">,</span><span class="n">f1ci_err</span><span class="p">,</span><span class="n">m1ci</span><span class="p">,</span><span class="n">f1scnci</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[]</span><span class="c1">#np.zeros(mshaps[1]),np.zeros(mshaps[1]),np.zeros(mshaps[1])</span>
            <span class="n">f2tot</span><span class="p">,</span><span class="n">f2tot_err</span><span class="p">,</span><span class="n">m2tot</span><span class="p">,</span><span class="n">f2scntot</span><span class="p">,</span><span class="n">f2ci</span><span class="p">,</span><span class="n">f2ci_err</span><span class="p">,</span><span class="n">m2ci</span><span class="p">,</span><span class="n">f2scnci</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[]</span><span class="c1">#np.zeros(mshaps[1]),np.zeros(mshaps[1]),np.zeros(mshaps[1])</span>
            <span class="n">fratdat</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:[</span><span class="n">f1tot</span><span class="p">,</span><span class="n">f1tot_err</span><span class="p">,</span><span class="n">m1tot</span><span class="p">,</span><span class="n">f1scntot</span><span class="p">],</span><span class="s1">&#39;Fci&#39;</span><span class="p">:[</span><span class="n">f1ci</span><span class="p">,</span><span class="n">f1ci_err</span><span class="p">,</span><span class="n">m1ci</span><span class="p">,</span><span class="n">f1scnci</span><span class="p">]},</span>
                       <span class="p">{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:[</span><span class="n">f2tot</span><span class="p">,</span><span class="n">f2tot_err</span><span class="p">,</span><span class="n">m2tot</span><span class="p">,</span><span class="n">f2scntot</span><span class="p">],</span><span class="s1">&#39;Fci&#39;</span><span class="p">:[</span><span class="n">f2ci</span><span class="p">,</span><span class="n">f2ci_err</span><span class="p">,</span><span class="n">m2ci</span><span class="p">,</span><span class="n">f2scnci</span><span class="p">]}]</span>
            <span class="k">for</span> <span class="n">li</span><span class="p">,</span><span class="n">lin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lratdat</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">nogood</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="n">pp</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">jlin</span> <span class="ow">in</span> <span class="n">lin</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="n">linelist</span><span class="p">[</span><span class="n">jlin</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">nogood</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lij_datOUT</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="n">jlin</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                            <span class="n">lij_snrOUT</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="n">jlin</span><span class="p">][</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span>
                            <span class="n">lij_ftot</span><span class="p">,</span><span class="n">lij_ftotER</span><span class="p">,</span><span class="n">lij_ftotMASK</span> <span class="o">=</span> <span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                            <span class="n">lij_fci</span><span class="p">,</span><span class="n">lij_fciER</span><span class="p">,</span><span class="n">lij_fciMASK</span>    <span class="o">=</span> <span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_ftot</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_ftotER</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lij_ftotMASK</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_snrOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_fci</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_fciER</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lij_fciMASK</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_snrOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nogood</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lin</span><span class="p">):</span>
                        <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="n">linelist</span><span class="p">[</span><span class="n">lin</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">li_datOUT</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="n">lin</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                    <span class="n">li_snrOUT</span> <span class="o">=</span> <span class="n">linelist</span><span class="p">[</span><span class="n">lin</span><span class="p">][</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span>
                    <span class="n">li_ftot</span><span class="p">,</span><span class="n">li_ftotER</span><span class="p">,</span><span class="n">li_ftotMASK</span> <span class="o">=</span> <span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                    <span class="n">li_fci</span><span class="p">,</span><span class="n">li_fciER</span><span class="p">,</span><span class="n">li_fciMASK</span>    <span class="o">=</span> <span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_ftot</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_ftotER</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_ftotMASK</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_snrOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_fci</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_fciER</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_fciMASK</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_snrOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cntr</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">fi</span><span class="p">,</span><span class="n">lratF</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lratdat</span><span class="p">[</span><span class="s1">&#39;lrat&#39;</span><span class="p">]</span> <span class="p">):</span>
                    <span class="c1"># print(fratdat[0])</span>
                    <span class="n">fi_mask</span> <span class="o">=</span> <span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">fi_frat</span> <span class="o">=</span> <span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">frat10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fi_frat</span><span class="p">)</span><span class="o">*</span><span class="n">fi_mask</span>
                    <span class="n">frat10err</span> <span class="o">=</span> <span class="n">lgerr</span><span class="p">(</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                                      <span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">frat10</span><span class="p">,</span><span class="n">frat10err</span><span class="p">]</span>

        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># Do the plotting here</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># if cntr != 0 and bptc != 0:</span>
        <span class="n">nps</span> <span class="o">=</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">xyCenter</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xcol</span> <span class="o">=</span> <span class="n">xgrid</span>
        <span class="n">ycol</span> <span class="o">=</span> <span class="n">ygrid</span>
        <span class="k">if</span> <span class="n">KPC</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">:</span>
            <span class="n">xcol</span> <span class="o">=</span> <span class="p">(</span><span class="n">xgrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ycol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ygrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># --------------------------</span>
        <span class="c1"># Plot ine ratio map</span>
        <span class="c1"># --------------------------</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">PLTNUM</span><span class="p">)</span>
        <span class="n">figDIM</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">nps</span><span class="p">]</span>
        <span class="n">figOUT</span> <span class="o">=</span> <span class="n">set_figSize</span><span class="p">(</span><span class="n">figDIM</span><span class="p">,</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nps</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">PLTNUM</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="c1">#, gridspec_kw={&#39;height_ratios&#39;: [1, 2]})</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">CMAP</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span>
        <span class="n">cmap_r</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">CMAP</span><span class="p">)</span>
        <span class="n">cmap_r</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_bkg</span><span class="p">)</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">linrat</span> <span class="ow">in</span> <span class="n">lineratios</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">xcol</span><span class="p">,</span><span class="n">ycol</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nps</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;spaxel&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;spaxel&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">KPC</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Relative distance [kpc]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Relative distance [kpc]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                    <span class="n">prelud</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">ni</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">prelud</span> <span class="o">=</span> <span class="s1">&#39;Ftot: &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prelud</span> <span class="o">=</span> <span class="s1">&#39;Fc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">prelud</span><span class="o">+</span><span class="s1">&#39;log$_</span><span class="si">{10}</span><span class="s1">$ &#39;</span><span class="o">+</span><span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;pltname&#39;</span><span class="p">],</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                    <span class="c1"># ax[ni].set_ylim([min(xx),np.ceil(max(xx))])</span>
                    <span class="c1"># ax[ni].set_xlim([min(yy),np.ceil(max(yy))])</span>
                <span class="k">for</span> <span class="n">li</span><span class="p">,</span><span class="n">lratF</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;Ftot&#39;</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">lratF</span> <span class="o">==</span> <span class="s1">&#39;Fci&#39;</span><span class="p">:</span>
                        <span class="n">frat10</span><span class="p">,</span><span class="n">frat10err</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                            <span class="n">display_pixels_wz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">frat10</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">],</span> <span class="n">CMAP</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="o">+</span><span class="n">ci</span><span class="p">],</span>
                                              <span class="n">VMIN</span><span class="o">=</span><span class="n">VMINMAX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VMAX</span><span class="o">=</span><span class="n">VMINMAX</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NTICKS</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">frat10</span><span class="p">,</span><span class="n">frat10err</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">display_pixels_wz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span> <span class="n">frat10</span><span class="p">,</span> <span class="n">CMAP</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="p">],</span>
                                          <span class="n">VMIN</span><span class="o">=</span><span class="n">VMINMAX</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VMAX</span><span class="o">=</span><span class="n">VMINMAX</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NTICKS</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># pltname,pltrange = lineratios[linrat][&#39;pltname&#39;],lineratios[linrat][&#39;pltrange&#39;]</span>
                <span class="n">cf</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SAVEDATA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pltsave_name</span> <span class="o">=</span> <span class="s1">&#39;emlin_ratio_map.png&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving figure:&#39;</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">return</span></div>



<div class="viewcode-block" id="Q3Dpro.make_BPT">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.make_BPT">[docs]</a>
    <span class="k">def</span> <span class="nf">make_BPT</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SNRCUT</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">SAVEDATA</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">PLTNUM</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">KPC</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># first identify the lines, extract fluxes, and apply the SNR cuts</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="n">BPTlines</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Hbeta&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;[OIII]5007&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;[OI]6300&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;Halpha&#39;</span> <span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;[NII]6548&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;[NII]6583&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;[SII]6716&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;[SII]6731&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>

        <span class="n">redshift</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_zsys_gas</span><span class="p">()</span>

        <span class="n">arckpc</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="n">redshift</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">60.</span>
        <span class="n">mshaps</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">li</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">lin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">linedat</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lin</span> <span class="ow">in</span> <span class="n">BPTlines</span><span class="p">:</span>
                <span class="n">ncomp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q3dinit</span><span class="o">.</span><span class="n">ncomp</span><span class="p">[</span><span class="n">lin</span><span class="p">])</span>
                <span class="c1"># fluxsum     = self.linedat.get_flux(lin,FLUXSEL=&#39;ftot&#39;)[&#39;flux&#39;]</span>
                <span class="c1"># fluxsum_err = self.linedat.get_flux(lin,FLUXSEL=&#39;ftot&#39;)[&#39;fluxerr&#39;]</span>
                <span class="n">wave0</span><span class="p">,</span> <span class="n">linetext</span><span class="p">,</span> <span class="n">dataOUT</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_linemap</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span> <span class="n">APPLYMASK</span><span class="o">=</span><span class="p">{})</span>
                <span class="n">istruct</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wavcen&#39;</span><span class="p">:</span><span class="n">wave0</span><span class="p">,</span><span class="s1">&#39;wname&#39;</span><span class="p">:</span><span class="n">linetext</span><span class="p">,</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="n">dataOUT</span><span class="p">,</span><span class="s1">&#39;snr&#39;</span><span class="p">:{}}</span>
                <span class="k">for</span> <span class="n">ditem</span> <span class="ow">in</span> <span class="n">dataOUT</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[],[],[]]</span>
                        <span class="k">if</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                            <span class="n">i_snc</span><span class="p">,</span><span class="n">i_gindx</span><span class="p">,</span><span class="n">i_bindx</span> <span class="o">=</span> <span class="n">snr_cut</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">],</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">],</span><span class="n">SNRCUT</span><span class="o">=</span><span class="n">SNRCUT</span><span class="p">)</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">0</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">]</span> <span class="o">=</span> <span class="n">i_snc</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_gindx</span><span class="p">)</span>
                            <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_bindx</span><span class="p">)</span>
                        <span class="n">li</span><span class="o">+=</span><span class="mi">0</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">li</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">mshaps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                        <span class="n">i_snc</span><span class="p">,</span><span class="n">i_gindx</span><span class="p">,</span><span class="n">i_bindx</span> <span class="o">=</span> <span class="n">snr_cut</span><span class="p">(</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">SNRCUT</span><span class="o">=</span><span class="n">SNRCUT</span><span class="p">)</span>
                        <span class="n">istruct</span><span class="p">[</span><span class="s1">&#39;snr&#39;</span><span class="p">][</span><span class="n">ditem</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">i_snc</span><span class="p">,</span><span class="n">i_gindx</span><span class="p">,</span><span class="n">i_bindx</span><span class="p">]</span>
                <span class="n">BPTlines</span><span class="p">[</span><span class="n">lin</span><span class="p">]</span> <span class="o">=</span> <span class="n">istruct</span>

               <span class="c1">#redshift = self.q3dinit.zinit_gas[lin]</span>
               <span class="c1">#matrix_size = redshift.shape</span>
               <span class="c1">#redshift = redshift.reshape(matrix_size[0],matrix_size[1])</span>
               <span class="c1">#arckpc = cosmo.kpc_proper_per_arcmin(redshift).value/60.</span>
               <span class="c1"># BPTlines[lin] = [fluxsum,fluxsum_err,flux_snc,fmask,gud_indx]</span>

        <span class="n">lineratios</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OiiiHb&#39;</span><span class="p">:{</span><span class="s1">&#39;lines&#39;</span><span class="p">:[</span><span class="s1">&#39;[OIII]5007&#39;</span><span class="p">,</span><span class="s1">&#39;Hbeta&#39;</span><span class="p">],</span><span class="s1">&#39;pltname&#39;</span><span class="p">:</span><span class="s1">&#39;[OIII]/H$</span><span class="se">\\</span><span class="s1">beta$&#39;</span><span class="p">,</span><span class="s1">&#39;pltrange&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mf">1.5</span><span class="p">],</span>
                                <span class="s1">&#39;lrat&#39;</span><span class="p">:{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}},</span>
                        <span class="s1">&#39;SiiHa&#39;</span> <span class="p">:{</span><span class="s1">&#39;lines&#39;</span><span class="p">:[[</span><span class="s1">&#39;[SII]6716&#39;</span><span class="p">,</span><span class="s1">&#39;[SII]6731&#39;</span><span class="p">],</span><span class="s1">&#39;Halpha&#39;</span><span class="p">],</span><span class="s1">&#39;pltname&#39;</span><span class="p">:</span><span class="s1">&#39;[SII]/H$</span><span class="se">\\</span><span class="s1">alpha$&#39;</span><span class="p">,</span><span class="s1">&#39;pltrange&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mf">1.8</span><span class="p">,</span><span class="mf">0.9</span><span class="p">],</span>
                                  <span class="s1">&#39;lrat&#39;</span><span class="p">:{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}},</span>
                        <span class="s1">&#39;OiHa&#39;</span>  <span class="p">:{</span><span class="s1">&#39;lines&#39;</span><span class="p">:[</span><span class="s1">&#39;[OI]6300&#39;</span><span class="p">,</span><span class="s1">&#39;Halpha&#39;</span><span class="p">],</span><span class="s1">&#39;pltname&#39;</span><span class="p">:</span><span class="s1">&#39;[OI]/H$</span><span class="se">\\</span><span class="s1">alpha$&#39;</span><span class="p">,</span><span class="s1">&#39;pltrange&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mf">1.8</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span>
                                  <span class="s1">&#39;lrat&#39;</span><span class="p">:{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}},</span>
                       <span class="s1">&#39;NiiHa&#39;</span> <span class="p">:{</span><span class="s1">&#39;lines&#39;</span><span class="p">:[</span><span class="s1">&#39;[NII]6583&#39;</span><span class="p">,</span><span class="s1">&#39;Halpha&#39;</span><span class="p">],</span><span class="s1">&#39;pltname&#39;</span><span class="p">:</span><span class="s1">&#39;[NII]/H$</span><span class="se">\\</span><span class="s1">alpha$&#39;</span><span class="p">,</span><span class="s1">&#39;pltrange&#39;</span><span class="p">:[</span><span class="o">-</span><span class="mf">1.8</span><span class="p">,</span><span class="mf">0.1</span><span class="p">],</span>
                                 <span class="s1">&#39;lrat&#39;</span><span class="p">:{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}},</span>
                      <span class="p">}</span>

        <span class="n">BPTmod</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;OiiiHb/NiiHa&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;OiiiHb/SiiHa&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;OiiiHb/OiHa&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># make the theoretical BPT models</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="k">for</span> <span class="n">bpt</span> <span class="ow">in</span> <span class="n">BPTmod</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bpt</span> <span class="o">==</span> <span class="s1">&#39;OiiiHb/NiiHa&#39;</span> <span class="p">:</span>
                <span class="n">xkew1</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">110</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span>
                <span class="n">ykew1</span> <span class="o">=</span> <span class="mf">0.61</span> <span class="o">/</span> <span class="p">(</span><span class="n">xkew1</span><span class="o">-</span><span class="mf">0.47</span><span class="p">)</span><span class="o">+</span><span class="mf">1.19</span>
                <span class="n">xkew2</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span>
                <span class="n">ykew2</span> <span class="o">=</span> <span class="mf">0.61</span> <span class="o">/</span> <span class="p">(</span><span class="n">xkew2</span><span class="o">-</span><span class="mf">0.05</span><span class="p">)</span><span class="o">+</span><span class="mf">1.3</span>
                <span class="n">BPTmod</span><span class="p">[</span><span class="n">bpt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xkew1</span><span class="p">,</span><span class="n">ykew1</span><span class="p">],[</span><span class="n">xkew2</span><span class="p">,</span><span class="n">ykew2</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">bpt</span> <span class="o">==</span> <span class="s1">&#39;OiiiHb/SiiHa&#39;</span> <span class="p">:</span>
                <span class="n">xkew1</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">105</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span>
                <span class="n">ykew1</span> <span class="o">=</span> <span class="mf">0.72</span> <span class="o">/</span> <span class="p">(</span><span class="n">xkew1</span><span class="o">-</span><span class="mf">0.32</span><span class="p">)</span><span class="o">+</span><span class="mf">1.30</span>
                <span class="n">xkew2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">0.4</span>
                <span class="n">ykew2</span> <span class="o">=</span> <span class="mf">1.89</span><span class="o">*</span><span class="n">xkew2</span><span class="o">+</span><span class="mf">0.76</span>
                <span class="n">BPTmod</span><span class="p">[</span><span class="n">bpt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xkew1</span><span class="p">,</span><span class="n">ykew1</span><span class="p">],[</span><span class="n">xkew2</span><span class="p">,</span><span class="n">ykew2</span><span class="p">]]</span>
            <span class="k">elif</span> <span class="n">bpt</span> <span class="o">==</span> <span class="s1">&#39;OiiiHb/OiHa&#39;</span> <span class="p">:</span>
                <span class="n">xkew1</span> <span class="o">=</span> <span class="mf">0.05</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">85</span><span class="p">)</span><span class="o">-</span><span class="mi">5</span>
                <span class="n">ykew1</span> <span class="o">=</span> <span class="mf">0.73</span> <span class="o">/</span> <span class="p">(</span><span class="n">xkew1</span><span class="o">+</span><span class="mf">0.59</span><span class="p">)</span><span class="o">+</span><span class="mf">1.33</span>
                <span class="n">xkew2</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="mf">1.1</span>
                <span class="n">ykew2</span> <span class="o">=</span> <span class="mf">1.18</span><span class="o">*</span><span class="n">xkew2</span> <span class="o">+</span> <span class="mf">1.30</span>
                <span class="n">BPTmod</span><span class="p">[</span><span class="n">bpt</span><span class="p">]</span> <span class="o">=</span> <span class="p">[[</span><span class="n">xkew1</span><span class="p">,</span><span class="n">ykew1</span><span class="p">],[</span><span class="n">xkew2</span><span class="p">,</span><span class="n">ykew2</span><span class="p">]]</span>

        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># Calculate the line ratios</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;calculating line ratios...&#39;</span><span class="p">)</span>
        <span class="n">cntr</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># bptc = 0</span>
        <span class="k">for</span> <span class="n">lrat</span><span class="p">,</span><span class="n">lratdat</span> <span class="ow">in</span> <span class="n">lineratios</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">f1tot</span><span class="p">,</span><span class="n">f1tot_err</span><span class="p">,</span><span class="n">m1tot</span><span class="p">,</span><span class="n">f1scntot</span><span class="p">,</span><span class="n">f1ci</span><span class="p">,</span><span class="n">f1ci_err</span><span class="p">,</span><span class="n">m1ci</span><span class="p">,</span><span class="n">f1scnci</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[]</span><span class="c1">#np.zeros(mshaps[1]),np.zeros(mshaps[1]),np.zeros(mshaps[1])</span>
            <span class="n">f2tot</span><span class="p">,</span><span class="n">f2tot_err</span><span class="p">,</span><span class="n">m2tot</span><span class="p">,</span><span class="n">f2scntot</span><span class="p">,</span><span class="n">f2ci</span><span class="p">,</span><span class="n">f2ci_err</span><span class="p">,</span><span class="n">m2ci</span><span class="p">,</span><span class="n">f2scnci</span> <span class="o">=</span> <span class="p">[],[],[],[],[],[],[],[]</span><span class="c1">#np.zeros(mshaps[1]),np.zeros(mshaps[1]),np.zeros(mshaps[1])</span>
            <span class="n">fratdat</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:[</span><span class="n">f1tot</span><span class="p">,</span><span class="n">f1tot_err</span><span class="p">,</span><span class="n">m1tot</span><span class="p">,</span><span class="n">f1scntot</span><span class="p">],</span><span class="s1">&#39;Fci&#39;</span><span class="p">:[</span><span class="n">f1ci</span><span class="p">,</span><span class="n">f1ci_err</span><span class="p">,</span><span class="n">m1ci</span><span class="p">,</span><span class="n">f1scnci</span><span class="p">]},</span>
                       <span class="p">{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:[</span><span class="n">f2tot</span><span class="p">,</span><span class="n">f2tot_err</span><span class="p">,</span><span class="n">m2tot</span><span class="p">,</span><span class="n">f2scntot</span><span class="p">],</span><span class="s1">&#39;Fci&#39;</span><span class="p">:[</span><span class="n">f2ci</span><span class="p">,</span><span class="n">f2ci_err</span><span class="p">,</span><span class="n">m2ci</span><span class="p">,</span><span class="n">f2scnci</span><span class="p">]}]</span>
            <span class="k">for</span> <span class="n">li</span><span class="p">,</span><span class="n">lin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lratdat</span><span class="p">[</span><span class="s1">&#39;lines&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lin</span><span class="p">,</span><span class="nb">list</span><span class="p">):</span>
                    <span class="n">nogood</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">for</span> <span class="n">pp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">):</span>
                        <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="n">pp</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="n">pp</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span><span class="mi">1</span>
                    <span class="k">for</span> <span class="n">jlin</span> <span class="ow">in</span> <span class="n">lin</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="n">BPTlines</span><span class="p">[</span><span class="n">jlin</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">nogood</span><span class="o">+=</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">lij_datOUT</span> <span class="o">=</span> <span class="n">BPTlines</span><span class="p">[</span><span class="n">jlin</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                            <span class="n">lij_snrOUT</span> <span class="o">=</span> <span class="n">BPTlines</span><span class="p">[</span><span class="n">jlin</span><span class="p">][</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span>
                            <span class="n">lij_ftot</span><span class="p">,</span><span class="n">lij_ftotER</span><span class="p">,</span><span class="n">lij_ftotMASK</span> <span class="o">=</span> <span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                            <span class="n">lij_fci</span><span class="p">,</span><span class="n">lij_fciER</span><span class="p">,</span><span class="n">lij_fciMASK</span>    <span class="o">=</span> <span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">lij_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_ftot</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_ftotER</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lij_ftotMASK</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_snrOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_fci</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_fciER</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="n">lij_fciMASK</span>
                            <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lij_snrOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">nogood</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">lin</span><span class="p">):</span>
                        <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">break</span>
                <span class="k">elif</span> <span class="n">BPTlines</span><span class="p">[</span><span class="n">lin</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">li_datOUT</span> <span class="o">=</span> <span class="n">BPTlines</span><span class="p">[</span><span class="n">lin</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
                    <span class="n">li_snrOUT</span> <span class="o">=</span> <span class="n">BPTlines</span><span class="p">[</span><span class="n">lin</span><span class="p">][</span><span class="s1">&#39;snr&#39;</span><span class="p">]</span>
                    <span class="n">li_ftot</span><span class="p">,</span><span class="n">li_ftotER</span><span class="p">,</span><span class="n">li_ftotMASK</span> <span class="o">=</span> <span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                    <span class="n">li_fci</span><span class="p">,</span><span class="n">li_fciER</span><span class="p">,</span><span class="n">li_fciMASK</span>    <span class="o">=</span> <span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">],</span><span class="n">li_datOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_ftot</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_ftotER</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_ftotMASK</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_snrOUT</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_fci</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_fciER</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_fciMASK</span>
                    <span class="n">fratdat</span><span class="p">[</span><span class="n">li</span><span class="p">][</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">li_snrOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cntr</span> <span class="o">+=</span><span class="mi">1</span>
                <span class="k">for</span> <span class="n">fi</span><span class="p">,</span><span class="n">lratF</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lratdat</span><span class="p">[</span><span class="s1">&#39;lrat&#39;</span><span class="p">]</span> <span class="p">):</span>
                    <span class="c1"># print(fratdat[0])</span>
                    <span class="n">fi_mask</span> <span class="o">=</span> <span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                    <span class="n">fi_frat</span> <span class="o">=</span> <span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span><span class="o">/</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    <span class="n">frat10</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">fi_frat</span><span class="p">)</span><span class="o">*</span><span class="n">fi_mask</span>
                    <span class="n">frat10err</span> <span class="o">=</span> <span class="n">lgerr</span><span class="p">(</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span>
                                      <span class="n">fratdat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">fratdat</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">lineratios</span><span class="p">[</span><span class="n">lrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">]</span><span class="o">=</span><span class="p">[</span><span class="n">frat10</span><span class="p">,</span><span class="n">frat10err</span><span class="p">]</span>

        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># Do the plotting here</span>
        <span class="c1"># ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span>
        <span class="c1"># if cntr != 0 and bptc != 0:</span>
        <span class="n">nps</span> <span class="o">=</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">xyCenter</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))]</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xcol</span> <span class="o">=</span> <span class="n">xgrid</span>
        <span class="n">ycol</span> <span class="o">=</span> <span class="n">ygrid</span>
        <span class="k">if</span> <span class="n">KPC</span> <span class="o">==</span> <span class="kc">True</span> <span class="p">:</span>
            <span class="n">xcol</span> <span class="o">=</span> <span class="p">(</span><span class="n">xgrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ycol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ygrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="c1"># --------------------------</span>
        <span class="c1"># Plot line ratio map</span>
        <span class="c1"># --------------------------</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">PLTNUM</span><span class="p">)</span>
        <span class="n">figDIM</span> <span class="o">=</span> <span class="p">[</span><span class="n">nps</span><span class="p">,</span><span class="n">cntr</span><span class="p">]</span>
        <span class="n">figOUT</span> <span class="o">=</span> <span class="n">set_figSize</span><span class="p">(</span><span class="n">figDIM</span><span class="p">,</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nps</span><span class="p">,</span><span class="n">cntr</span><span class="p">,</span><span class="n">num</span><span class="o">=</span><span class="n">PLTNUM</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span><span class="c1">#, gridspec_kw={&#39;height_ratios&#39;: [1, 2]})</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">CMAP</span><span class="o">=</span><span class="s1">&#39;inferno&#39;</span>
        <span class="n">cmap_r</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">CMAP</span><span class="p">)</span>
        <span class="n">cmap_r</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">map_bkg</span><span class="p">)</span>
        <span class="n">cf</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">linrat</span> <span class="ow">in</span> <span class="n">lineratios</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="n">xx</span><span class="p">,</span><span class="n">yy</span> <span class="o">=</span> <span class="n">xcol</span><span class="p">,</span><span class="n">ycol</span>
                <span class="c1"># iax = ax[cf]</span>
                <span class="n">pltname</span><span class="p">,</span><span class="n">pltrange</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;pltname&#39;</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;pltrange&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nps</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;spaxel&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;spaxel&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">KPC</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Relative distance [kpc]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Relative distance [kpc]&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
                    <span class="n">prelud</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">ni</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">prelud</span> <span class="o">=</span> <span class="s1">&#39;Ftot: &#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">prelud</span> <span class="o">=</span> <span class="s1">&#39;Fc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;: &#39;</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">prelud</span><span class="o">+</span><span class="s1">&#39;log$_</span><span class="si">{10}</span><span class="s1">$ &#39;</span><span class="o">+</span><span class="n">pltname</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">pad</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
                    <span class="c1"># ax[ni,cf].set_ylim([max(xx),np.ceil(min(xx))])</span>
                    <span class="c1"># ax[ni,cf].set_xlim([min(yy),np.ceil(max(yy))])</span>

                <span class="k">for</span> <span class="n">li</span><span class="p">,</span><span class="n">lratF</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;Ftot&#39;</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="n">lratF</span> <span class="o">==</span> <span class="s1">&#39;Fci&#39;</span><span class="p">:</span>
                        <span class="n">frat10</span><span class="p">,</span><span class="n">frat10err</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                            <span class="n">display_pixels_wz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span>
                                              <span class="n">frat10</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">],</span> <span class="n">CMAP</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="o">+</span><span class="n">ci</span><span class="p">,</span><span class="n">cf</span><span class="p">],</span>
                                              <span class="n">VMIN</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">VMAX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">NTICKS</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">frat10</span><span class="p">,</span><span class="n">frat10err</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">linrat</span><span class="p">][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">display_pixels_wz</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="n">xx</span><span class="p">,</span>
                                          <span class="n">frat10</span><span class="p">,</span> <span class="n">CMAP</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="p">,</span><span class="n">cf</span><span class="p">],</span>
                                          <span class="n">VMIN</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">VMAX</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">NTICKS</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">cf</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SAVEDATA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pltsave_name</span> <span class="o">=</span> <span class="s1">&#39;emlin_ratio_map.png&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving figure:&#39;</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="c1"># --------------------------</span>
        <span class="c1"># Plot BPT here</span>
        <span class="c1"># --------------------------</span>
        <span class="n">PLTNUM</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">PLTNUM</span><span class="p">)</span>
        <span class="n">figDIM</span> <span class="o">=</span> <span class="p">[</span><span class="n">nps</span><span class="p">,</span><span class="n">cntr</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">figOUT</span> <span class="o">=</span> <span class="n">set_figSize</span><span class="p">(</span><span class="n">figDIM</span><span class="p">,</span><span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">SQUARE</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nps</span><span class="p">,</span><span class="n">cntr</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">((</span><span class="n">cntr</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">),</span><span class="n">num</span><span class="o">=</span><span class="n">PLTNUM</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figheight</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_figwidth</span><span class="p">(</span><span class="n">figOUT</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">cf</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">pixkpc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix</span><span class="o">*</span><span class="n">arckpc</span>
        <span class="n">xgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mshaps</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xcol</span> <span class="o">=</span> <span class="p">(</span><span class="n">xgrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ycol</span> <span class="o">=</span> <span class="p">(</span><span class="n">ygrid</span><span class="o">-</span><span class="n">xyCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">xcolkpc</span> <span class="o">=</span> <span class="n">xcol</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">arckpc</span><span class="p">)</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix</span>
        <span class="n">ycolkpc</span> <span class="o">=</span> <span class="n">ycol</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">arckpc</span><span class="p">)</span><span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pix</span>
        <span class="k">for</span> <span class="n">bpt</span> <span class="ow">in</span> <span class="n">BPTmod</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">bpt</span> <span class="o">!=</span> <span class="kc">None</span> <span class="p">:</span>
                <span class="k">for</span> <span class="n">li</span><span class="p">,</span><span class="n">lratF</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;Ftot&#39;</span><span class="p">,</span><span class="s1">&#39;Fci&#39;</span><span class="p">]):</span>
                    <span class="n">fnames</span> <span class="o">=</span> <span class="n">bpt</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="c1"># pltname,pltrange = lineratios[linrat][&#39;pltname&#39;],lineratios[fnames[0]][&#39;pltrange&#39;]</span>
                    <span class="n">pltname1</span><span class="p">,</span><span class="n">pltrange1</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;pltname&#39;</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;pltrange&#39;</span><span class="p">]</span>
                    <span class="n">pltname2</span><span class="p">,</span><span class="n">pltrange2</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;pltname&#39;</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;pltrange&#39;</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lratF</span> <span class="o">==</span> <span class="s1">&#39;Fci&#39;</span><span class="p">:</span>
                        <span class="n">frat10_A</span><span class="p">,</span><span class="n">frat10errA</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">frat10_B</span><span class="p">,</span><span class="n">frat10errB</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">ci</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">ncomp</span><span class="p">):</span>
                            <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">frat10_A</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">frat10_B</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">]))</span>
                            <span class="n">xfract</span><span class="p">,</span><span class="n">yfract</span> <span class="o">=</span> <span class="n">frat10_B</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">][</span><span class="n">gg</span><span class="p">],</span><span class="n">frat10_A</span><span class="p">[:,:,</span><span class="n">ci</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span>
                            <span class="n">xfracterr</span><span class="p">,</span><span class="n">yfracterr</span> <span class="o">=</span> <span class="p">[</span><span class="n">frat10errB</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">frat10errB</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],[</span><span class="n">frat10errA</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">frat10errA</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,:,</span><span class="n">ci</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
                            <span class="n">ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&amp;</span>  <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="o">+</span><span class="n">ci</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">yfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                  <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="o">+</span><span class="n">ci</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">yfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                                <span class="n">xerr</span><span class="o">=</span><span class="p">[</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ee</span><span class="p">],</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ee</span><span class="p">]],</span><span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ee</span><span class="p">],</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ee</span><span class="p">]],</span>
                                            <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                            <span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="o">+</span><span class="n">ci</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frat10_B</span><span class="p">[</span><span class="n">gg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ci</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">frat10_A</span><span class="p">[</span><span class="n">gg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">gg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">ci</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
                                                  <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">frat10_A</span><span class="p">,</span><span class="n">frat10errA</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">frat10_B</span><span class="p">,</span><span class="n">frat10errB</span> <span class="o">=</span> <span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">lineratios</span><span class="p">[</span><span class="n">fnames</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;lrat&#39;</span><span class="p">][</span><span class="n">lratF</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        <span class="n">gg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">frat10_B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">frat10_A</span><span class="p">))</span>
                        <span class="n">xfract</span><span class="p">,</span><span class="n">yfract</span>       <span class="o">=</span> <span class="n">frat10_B</span><span class="p">[</span><span class="n">gg</span><span class="p">],</span><span class="n">frat10_A</span><span class="p">[</span><span class="n">gg</span><span class="p">]</span>
                        <span class="n">xfracterr</span><span class="p">,</span><span class="n">yfracterr</span> <span class="o">=</span> <span class="p">[</span><span class="n">frat10errB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">frat10errB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()],[</span><span class="n">frat10errA</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span><span class="n">frat10errA</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">gg</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">()]</span>
                        <span class="n">ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">&amp;</span>  <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">yfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">xfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">yfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">ee</span><span class="p">],</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                                            <span class="n">xerr</span><span class="o">=</span><span class="p">[</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ee</span><span class="p">],</span><span class="n">xfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ee</span><span class="p">]],</span><span class="n">yerr</span><span class="o">=</span><span class="p">[</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">ee</span><span class="p">],</span><span class="n">yfracterr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">ee</span><span class="p">]],</span>
                                            <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">,</span><span class="n">ecolor</span><span class="o">=</span><span class="s1">&#39;dodgerblue&#39;</span><span class="p">,</span>
                                            <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">li</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">xfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span><span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">yfract</span><span class="o">.</span><span class="n">flatten</span><span class="p">()),</span>
                                            <span class="n">fillstyle</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span><span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">mew</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nps</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">2.1</span><span class="p">,</span><span class="mf">0.7</span><span class="p">])</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">pltrange1</span><span class="p">)</span>
                    <span class="c1"># first plot the theoretical curves</span>
                    <span class="n">iBPTmod</span> <span class="o">=</span> <span class="n">BPTmod</span><span class="p">[</span><span class="n">bpt</span><span class="p">]</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iBPTmod</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">iBPTmod</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;k-&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iBPTmod</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">iBPTmod</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;k--&#39;</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">1.5</span><span class="p">)</span>
                    <span class="n">compName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                    <span class="k">if</span> <span class="n">ni</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">compName</span> <span class="o">=</span> <span class="s1">&#39;Ftot&#39;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">compName</span> <span class="o">=</span> <span class="s1">&#39;Fc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span>

                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">cf</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">pltname1</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">compName</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
                                      <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                      <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">pltname2</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
                                  <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">ni</span><span class="p">,</span><span class="n">cf</span><span class="p">]</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;in&#39;</span><span class="p">,</span>
                                  <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
                <span class="n">cf</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span><span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">SAVEDATA</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">pltsave_name</span> <span class="o">=</span> <span class="s1">&#39;BPT_map.png&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving figure:&#39;</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span><span class="n">pltsave_name</span><span class="p">))</span>
        <span class="c1"># plt.savefig(tname+&#39;_c&#39;+str(int(ic+1))+&#39;_bpt.pdf&#39;)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
            <span class="c1"># breakpoint()</span>
        <span class="k">return</span></div>


<div class="viewcode-block" id="Q3Dpro.resort_line_components">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.Q3Dpro.resort_line_components">[docs]</a>
    <span class="k">def</span> <span class="nf">resort_line_components</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">dataIN</span><span class="p">,</span><span class="n">NCOMP</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">COMP_SORT</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">COMP_SORT</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dataIN</span><span class="p">,</span><span class="n">NCOMP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">COMP_SORT</span><span class="p">[</span><span class="s1">&#39;sort_by&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">dataIN</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;sort_range&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">COMP_SORT</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sort comp by:&#39;</span><span class="p">,</span><span class="n">COMP_SORT</span><span class="p">[</span><span class="s1">&#39;sort_by&#39;</span><span class="p">])</span>
                    <span class="n">dataOUT</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataIN</span><span class="p">)</span>
                    <span class="n">sortDat</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="n">COMP_SORT</span><span class="p">[</span><span class="s1">&#39;sort_by&#39;</span><span class="p">]]</span>
                    <span class="n">mshap</span> <span class="o">=</span> <span class="n">sortDat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mshap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mshap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="n">sij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">sortDat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]))</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sij</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">dataOUT</span><span class="p">,</span><span class="n">mshap</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sort_rang</span> <span class="o">=</span> <span class="n">COMP_SORT</span><span class="p">[</span><span class="s1">&#39;sort_range&#39;</span><span class="p">]</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;========================&#39;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;sort comp by:&#39;</span><span class="p">,</span><span class="n">COMP_SORT</span><span class="p">[</span><span class="s1">&#39;sort_by&#39;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">si</span><span class="p">,</span><span class="n">srang</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sort_rang</span><span class="p">):</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">si</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span><span class="n">srang</span><span class="p">)</span>
                    <span class="n">sortDat</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="n">COMP_SORT</span><span class="p">[</span><span class="s1">&#39;sort_by&#39;</span><span class="p">]]</span>
                    <span class="n">mshap</span> <span class="o">=</span> <span class="n">sortDat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
                    <span class="n">dataOUT</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;Ftot&#39;</span><span class="p">:</span><span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Ftot&#39;</span><span class="p">],</span>
                               <span class="s1">&#39;Fci&#39;</span><span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                               <span class="s1">&#39;Sig&#39;</span><span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                               <span class="s1">&#39;v50&#39;</span><span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">},</span>
                               <span class="s1">&#39;w80&#39;</span><span class="p">:{</span><span class="s1">&#39;data&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;err&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;mask&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}}</span>
                    <span class="k">for</span> <span class="n">ditem</span> <span class="ow">in</span> <span class="n">dataOUT</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ditem</span> <span class="o">!=</span> <span class="s1">&#39;Ftot&#39;</span><span class="p">:</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mshap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mshap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">sort_rang</span><span class="p">)))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mshap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mshap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">sort_rang</span><span class="p">)))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="n">dataOUT</span><span class="p">[</span><span class="n">ditem</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">mshap</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">mshap</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="nb">len</span><span class="p">(</span><span class="n">sort_rang</span><span class="p">)))</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mshap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mshap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                            <span class="k">for</span> <span class="n">cc</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">mshap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                                <span class="k">for</span> <span class="n">sri</span><span class="p">,</span><span class="n">sr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sort_rang</span><span class="p">):</span>
                                    <span class="c1"># dataOUT[&#39;Fci&#39;][&#39;name&#39;].append()</span>
                                    <span class="n">ici</span> <span class="o">=</span> <span class="n">sri</span>
                                    <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;F$_{c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
                                    <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;$\sigma_{c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
                                    <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;v$_{50,c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
                                    <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;w$_{80,c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ici</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;}$&#39;</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">sr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sortDat</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">sr</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span>  <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;err&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Fci&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;Sig&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;v50&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                        <span class="n">dataOUT</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">sri</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataIN</span><span class="p">[</span><span class="s1">&#39;w80&#39;</span><span class="p">][</span><span class="s1">&#39;mask&#39;</span><span class="p">][</span><span class="n">ii</span><span class="p">,</span><span class="n">jj</span><span class="p">,</span><span class="n">cc</span><span class="p">]</span>
                                <span class="c1"># print(&#39;---&#39;)</span>
                    <span class="k">return</span> <span class="n">dataOUT</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">sort_rang</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;SORT ERROR...&#39;</span><span class="p">)</span>
                <span class="k">pass</span></div>
</div>




<span class="c1"># =============================================================================================</span>
<span class="c1"># reading in the .npy and .npz files</span>
<span class="c1"># =============================================================================================</span>
<span class="c1"># Emission line data</span>
<span class="c1"># ---------------------------------------------------------------------------------------------</span>


<div class="viewcode-block" id="LineData">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.LineData">[docs]</a>
<span class="k">class</span> <span class="nc">LineData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Read in and store line data for all lines found in *.lin.npz file</span>
<span class="sd">    (which is output by q3da).</span>

<span class="sd">    Individual line measurements can be obtained with corresponding methods.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    q3di : object</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    lines : dict</span>
<span class="sd">        Line names.</span>
<span class="sd">    maxncomp : int</span>
<span class="sd">        Maximum number of components fit to a line.</span>
<span class="sd">    data : dict</span>
<span class="sd">        Contents of the line data (.npz) file.</span>
<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q3di</span><span class="p">):</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">q3di</span><span class="o">.</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;.line.npz&#39;</span>
        <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">q3di</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="c1"># print(datafile)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: emission line (&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;) file does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">q3di</span><span class="o">.</span><span class="n">lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">maxncomp</span> <span class="o">=</span> <span class="n">q3di</span><span class="o">.</span><span class="n">maxncomp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_npz</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="c1"># book-keeping inheritance from initproc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;ncols&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;nrows&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span> <span class="o">=</span> <span class="n">q3di</span><span class="o">.</span><span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">=</span> <span class="n">q3di</span><span class="o">.</span><span class="n">name</span>
        <span class="c1"># self.flux    = self.get_flux()</span>
        <span class="c1"># self.siga    = self.get_sigma()</span>
        <span class="c1"># self.wavelen = self.get_wave()</span>
        <span class="c1"># self.eq      = self.get_weq()</span>
        <span class="k">return</span>

<div class="viewcode-block" id="LineData.read_npz">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.LineData.read_npz">[docs]</a>
    <span class="k">def</span> <span class="nf">read_npz</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datafile</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Load binary line data file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        datafile : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Contents of datafile.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">dataread</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colname</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dataread</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataread</span></div>


<div class="viewcode-block" id="LineData.get_flux">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.LineData.get_flux">[docs]</a>
    <span class="k">def</span> <span class="nf">get_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineselect</span><span class="p">,</span> <span class="n">FLUXSEL</span><span class="o">=</span><span class="s1">&#39;ftot&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get flux and error of a given line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lineselect : str</span>
<span class="sd">            Which line to grab.</span>
<span class="sd">        fluxsel : str, default &#39;ftot&#39; (total flux)</span>
<span class="sd">            Which flux to grab. String names defined in q3da.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            keys flux, fluxerr contain ndarray(ncols, nrows, ncomp)</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="c1"># FLUXSEL = &#39;ftot&#39; by default --&gt; select from (&#39;ftot&#39;, &#39;fc1&#39;, &#39;fc1pk&#39;)</span>
        <span class="k">if</span> <span class="n">lineselect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: line does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">emlflx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlflx&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">emlflxerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlflxerr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">dataout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;flux&#39;</span><span class="p">:</span> <span class="n">emlflx</span><span class="p">[</span><span class="n">FLUXSEL</span><span class="p">][</span><span class="n">lineselect</span><span class="p">],</span>
                   <span class="s1">&#39;fluxerr&#39;</span><span class="p">:</span> <span class="n">emlflxerr</span><span class="p">[</span><span class="n">FLUXSEL</span><span class="p">][</span><span class="n">lineselect</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">dataout</span></div>


<div class="viewcode-block" id="LineData.get_ncomp">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.LineData.get_ncomp">[docs]</a>
    <span class="k">def</span> <span class="nf">get_ncomp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineselect</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get # components fit to a given line.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lineselect : str</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray(ncols, nrows)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">lineselect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: line does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlncomp&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">())[</span><span class="n">lineselect</span><span class="p">]</span></div>


<div class="viewcode-block" id="LineData.get_sigma">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.LineData.get_sigma">[docs]</a>
    <span class="k">def</span> <span class="nf">get_sigma</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineselect</span><span class="p">,</span> <span class="n">COMPSEL</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get sigma and error of a given line and component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lineselect : str</span>
<span class="sd">            Which line to grab.</span>
<span class="sd">        compsel : int, default 1</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            keys sig, sigerr contain ndarray(ncols, nrows)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">lineselect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: line does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># &#39;c1&#39;</span>
        <span class="n">emlsig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlsig&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">emlsigerr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlsigerr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">csel</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">COMPSEL</span><span class="p">)</span>
        <span class="n">dataout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sig&#39;</span><span class="p">:</span> <span class="n">emlsig</span><span class="p">[</span><span class="n">csel</span><span class="p">][</span><span class="n">lineselect</span><span class="p">],</span>
                   <span class="s1">&#39;sigerr&#39;</span><span class="p">:</span> <span class="n">emlsigerr</span><span class="p">[</span><span class="n">csel</span><span class="p">][</span><span class="n">lineselect</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">dataout</span></div>


<div class="viewcode-block" id="LineData.get_wave">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.LineData.get_wave">[docs]</a>
    <span class="k">def</span> <span class="nf">get_wave</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lineselect</span><span class="p">,</span> <span class="n">COMPSEL</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39; Get central wavelength and error of a given line and component.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lineselect : str</span>
<span class="sd">            Which line to grab.</span>
<span class="sd">        compsel : int, default 1</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            keys wav, waverr contain ndarray(ncols, nrows)</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">lineselect</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lines</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: line does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="c1"># &#39;c1&#39;</span>
        <span class="n">emlwav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlwav&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">emlwaverr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;emlwaverr&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="n">csel</span> <span class="o">=</span> <span class="s1">&#39;c&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">COMPSEL</span><span class="p">)</span>
        <span class="n">dataout</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;wav&#39;</span><span class="p">:</span> <span class="n">emlwav</span><span class="p">[</span><span class="n">csel</span><span class="p">][</span><span class="n">lineselect</span><span class="p">],</span>
                   <span class="s1">&#39;waverr&#39;</span><span class="p">:</span> <span class="n">emlwaverr</span><span class="p">[</span><span class="n">csel</span><span class="p">][</span><span class="n">lineselect</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">dataout</span></div>
</div>


    <span class="c1"># def get_weq(self, lineselect, FLUXSEL=&#39;ftot&#39;):</span>
    <span class="c1">#     # FLUXSEL = &#39;ftot&#39; by default --&gt; select from (&#39;ftot&#39;, &#39;fc1&#39;)</span>
    <span class="c1">#     if lineselect not in self.lines:</span>
    <span class="c1">#         print(&#39;ERROR: line does not exist&#39;)</span>
    <span class="c1">#         return None</span>
    <span class="c1">#     # &#39;ftot&#39;, &#39;fc1&#39;</span>
    <span class="c1">#     emlweq = self.data[&#39;emlweq&#39;].item()</span>
    <span class="c1">#     dataout = emlweq[FLUXSEL][lineselect]</span>
    <span class="c1">#     return dataout</span>


<div class="viewcode-block" id="OneLineData">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.OneLineData">[docs]</a>
<span class="k">class</span> <span class="nc">OneLineData</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Parse all line data for a given emission line from a LineData object.</span>

<span class="sd">    Parameters</span>
<span class="sd">    -----------</span>
<span class="sd">    linedata :</span>
<span class="sd">        Data from *.lin.npz file, stored in LineData.data.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    flux : ndarray(ncols, nrows, maxncomp)</span>
<span class="sd">    fpklux : ndarray(ncols, nrows, maxncomp)</span>
<span class="sd">    line : str</span>
<span class="sd">    ncomp : ndarray(ncols, nrows)</span>
<span class="sd">    sig : ndarray(ncols, nrows, maxncomp)</span>
<span class="sd">    wave : ndarray(ncols, nrows, maxncomp)</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt;</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">linedata</span><span class="p">,</span> <span class="n">lineselect</span><span class="p">):</span>
        <span class="c1"># inherit some stuff from linedata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">linedata</span><span class="o">.</span><span class="n">ncols</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span> <span class="o">=</span> <span class="n">linedata</span><span class="o">.</span><span class="n">nrows</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bad</span> <span class="o">=</span> <span class="n">linedata</span><span class="o">.</span><span class="n">bad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span> <span class="o">=</span> <span class="n">linedata</span><span class="o">.</span><span class="n">dataDIR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">=</span> <span class="n">linedata</span><span class="o">.</span><span class="n">target_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">=</span> <span class="n">lineselect</span>
        <span class="c1"># initialize arrays</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flux</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">linedata</span><span class="o">.</span><span class="n">ncols</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">),</span>
                     <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">linedata</span><span class="o">.</span><span class="n">bad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pkflux</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">linedata</span><span class="o">.</span><span class="n">ncols</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">),</span>
                     <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">linedata</span><span class="o">.</span><span class="n">bad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">linedata</span><span class="o">.</span><span class="n">ncols</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">),</span>
                     <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">linedata</span><span class="o">.</span><span class="n">bad</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave</span> <span class="o">=</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">linedata</span><span class="o">.</span><span class="n">ncols</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">nrows</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">),</span>
                     <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="n">linedata</span><span class="o">.</span><span class="n">bad</span>
        <span class="c1"># cycle through components to get maps</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linedata</span><span class="o">.</span><span class="n">maxncomp</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flux</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">linedata</span><span class="o">.</span><span class="n">get_flux</span><span class="p">(</span><span class="n">lineselect</span><span class="p">,</span> <span class="n">FLUXSEL</span><span class="o">=</span><span class="s1">&#39;fc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)))[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pkflux</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">linedata</span><span class="o">.</span><span class="n">get_flux</span><span class="p">(</span><span class="n">lineselect</span><span class="p">,</span>
                                   <span class="n">FLUXSEL</span><span class="o">=</span><span class="s1">&#39;fc&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;pk&#39;</span><span class="p">))[</span><span class="s1">&#39;flux&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">linedata</span><span class="o">.</span><span class="n">get_sigma</span><span class="p">(</span><span class="n">lineselect</span><span class="p">,</span> <span class="n">COMPSEL</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))[</span><span class="s1">&#39;sig&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                <span class="p">(</span><span class="n">linedata</span><span class="o">.</span><span class="n">get_wave</span><span class="p">(</span><span class="n">lineselect</span><span class="p">,</span> <span class="n">COMPSEL</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">))[</span><span class="s1">&#39;wav&#39;</span><span class="p">]</span>
        <span class="c1"># No. of components on a spaxel-by-spaxel basis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span> <span class="o">=</span> <span class="n">linedata</span><span class="o">.</span><span class="n">get_ncomp</span><span class="p">(</span><span class="n">lineselect</span><span class="p">)</span>

<div class="viewcode-block" id="OneLineData.calc_cvdf">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.OneLineData.calc_cvdf">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_cvdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zref</span><span class="p">,</span> <span class="n">vlimits</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mf">1e4</span><span class="p">,</span> <span class="mf">1e4</span><span class="p">],</span> <span class="n">vstep</span><span class="o">=</span><span class="mf">1.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute CVDF for this line, for each spaxel.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        zref : float</span>
<span class="sd">            Reference redshift for computing velocities</span>
<span class="sd">        vlimits : ndarray(2)</span>
<span class="sd">            limits for model velocities, in km/s</span>
<span class="sd">        vstep : float</span>
<span class="sd">            step for model velocities, in km/s</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        cvdf_vel : ndarray(nmod)</span>
<span class="sd">            Model velocities.</span>
<span class="sd">        vdf : ndarray(ncols, nrows, nmod)</span>
<span class="sd">            Velocity distribution in flux space.</span>
<span class="sd">        cvdf : ndarray(ncols, nrows, nmod)</span>
<span class="sd">            Cumulative velocity distribution function.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvdf_zref</span> <span class="o">=</span> <span class="n">zref</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvdf_vel</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">vdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cvdf</span> <span class="o">=</span> \
            <span class="n">cmpcvdf</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wave</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pkflux</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncomp</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span> <span class="n">zref</span><span class="p">,</span> <span class="n">vlimits</span><span class="o">=</span><span class="n">vlimits</span><span class="p">,</span> <span class="n">vstep</span><span class="o">=</span><span class="n">vstep</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cvdf_nmod</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvdf_vel</span><span class="p">)</span></div>


<div class="viewcode-block" id="OneLineData.calc_cvdf_vel">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.OneLineData.calc_cvdf_vel">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_cvdf_vel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">calc_from_posvel</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Compute a velocity at % pct from one side of the CVDF.</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>
<span class="sd">        pct : float</span>
<span class="sd">            Percentage at which to calculate velocity.</span>
<span class="sd">        calc_from_posvel : bool</span>
<span class="sd">            If True, v0% is at positive velocities.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ndarray(ncols, nrows)</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="k">if</span> <span class="n">calc_from_posvel</span><span class="p">:</span>
            <span class="n">pct_use</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">-</span> <span class="n">pct</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pct_use</span> <span class="o">=</span> <span class="n">pct</span>

        <span class="n">varr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">bad</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="p">):</span>
                <span class="n">ivel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvdf</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:],</span> <span class="n">pct_use</span><span class="o">/</span><span class="mf">100.</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ivel</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cvdf_nmod</span><span class="p">:</span>
                    <span class="c1"># for now, just interpolate between two points around value</span>
                    <span class="n">varr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvdf_vel</span><span class="p">[</span><span class="n">ivel</span><span class="p">]</span> <span class="o">+</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">cvdf_vel</span><span class="p">[</span><span class="n">ivel</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="k">return</span> <span class="n">varr</span></div>


<div class="viewcode-block" id="OneLineData.make_cvdf_map">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.OneLineData.make_cvdf_map">[docs]</a>
    <span class="k">def</span> <span class="nf">make_cvdf_map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pct</span><span class="p">,</span> <span class="n">velran</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">markcenter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axisunit</span><span class="o">=</span><span class="s1">&#39;spaxel&#39;</span><span class="p">,</span>
                      <span class="n">platescale</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">outfile</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">outformat</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">):</span>

        <span class="n">pixVals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_cvdf_vel</span><span class="p">(</span><span class="n">pct</span><span class="p">)</span>

        <span class="n">kpc_arcsec</span> <span class="o">=</span> <span class="n">cosmo</span><span class="o">.</span><span class="n">kpc_proper_per_arcmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cvdf_zref</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="mf">60.</span>

        <span class="c1"># single-offset column and row values</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="n">rows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">center</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
        <span class="n">cols_cent</span> <span class="o">=</span> <span class="p">(</span><span class="n">cols</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">rows_cent</span> <span class="o">=</span> <span class="p">(</span><span class="n">rows</span> <span class="o">-</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># This makes the axis span the spaxel values, with integer coordinate</span>
        <span class="c1"># being a pixel center. So a range of [1,5] spaxels will have an axis</span>
        <span class="c1"># range of [0.5,5.5]. This is what the extent keyword to imshow expects.</span>
        <span class="c1"># https://matplotlib.org/stable/tutorials/intermediate/imshow_extent.html</span>
        <span class="n">xran</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cols_cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cols_cent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span>
        <span class="n">yran</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">rows_cent</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">rows_cent</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">nrows</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mf">1.</span><span class="p">])</span> <span class="o">-</span> <span class="mf">0.5</span>

        <span class="n">XYtitle</span> <span class="o">=</span> <span class="s1">&#39;Spaxel&#39;</span>
        <span class="c1">#if axisunit == &#39;kpc&#39; and platescale is not None:</span>
        <span class="c1">#    kpc_pix = np.median(kpc_arcsec)*platescale</span>
        <span class="c1">#    xcolkpc = xcol*kpc_pix</span>
        <span class="c1">#    ycolkpc = ycol*kpc_pix</span>
        <span class="c1">#    xcol, ycol = xcolkpc, ycolkpc</span>
        <span class="c1">#    XYtitle = &#39;Relative distance [kpc]&#39;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">cmap</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="s1">&#39;RdYlBu_r&#39;</span>

        <span class="n">vticks</span> <span class="o">=</span> <span class="p">[</span><span class="n">velran</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">velran</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="n">velran</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">,</span> <span class="n">velran</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">nticks</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">cmap_r</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">)</span>
        <span class="n">cmap_r</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="c1"># cmap_r.set_bad(color=self.map_bkg)</span>
        <span class="n">display_pixels_wz</span><span class="p">(</span><span class="n">cols_cent</span><span class="p">,</span> <span class="n">rows_cent</span><span class="p">,</span> <span class="n">pixVals</span><span class="p">,</span> <span class="n">CMAP</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                          <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">VMIN</span><span class="o">=</span><span class="n">velran</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">VMAX</span><span class="o">=</span><span class="n">velran</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">TICKS</span><span class="o">=</span><span class="n">vticks</span><span class="p">,</span> <span class="n">NTICKS</span><span class="o">=</span><span class="n">nticks</span><span class="p">,</span> <span class="n">XRAN</span><span class="o">=</span><span class="n">xran</span><span class="p">,</span> <span class="n">YRAN</span><span class="o">=</span><span class="n">yran</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">markcenter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">markcenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">markcenter</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">mew</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                        <span class="n">mfc</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">XYtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">XYtitle</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span> <span class="s1">&#39;v&#39;</span> <span class="o">+</span>
                     <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pct</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; (km/s)&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="c1">#axi.set_title(ipdat[&#39;name&#39;][ci],fontsize=20,pad=45)</span>

            <span class="c1">#if savedata:</span>
            <span class="c1">#    linesave_name = self.target_name+&#39;_&#39;+LINESELECT+&#39;_&#39;+icomp+ici+&#39;_map.fits&#39;</span>
            <span class="c1">#    print(&#39;Saving line map:&#39;,linesave_name)</span>
            <span class="c1">#    savepath = os.path.join(self.dataDIR,linesave_name)</span>
            <span class="c1">#            save_to_fits(pixVals,[],savepath)</span>
        <span class="c1">#fig.suptitle(self.target_name+&#39; : &#39;+linetext+&#39; maps&#39;,fontsize=20,snap=True,</span>
        <span class="c1">#             horizontalalignment=&#39;right&#39;)</span>
        <span class="c1">#             # verticalalignment=&#39;center&#39;,</span>
        <span class="c1">#             # fontweight=&#39;semibold&#39;)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">(</span><span class="n">pad</span><span class="o">=</span><span class="mf">0.15</span><span class="p">,</span> <span class="n">h_pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">set_dpi</span><span class="p">(</span><span class="mf">300.</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">outfile</span><span class="p">:</span>
            <span class="n">pltsave_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_name</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span> <span class="o">+</span> <span class="s1">&#39;-v&#39;</span> <span class="o">+</span> \
                <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">pct</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;-map&#39;</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving &#39;</span><span class="p">,</span> <span class="n">pltsave_name</span><span class="p">,</span> <span class="s1">&#39; to &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataDIR</span><span class="p">,</span> <span class="n">pltsave_name</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span> <span class="o">+</span>
                                     <span class="n">outformat</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="n">outformat</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mf">100.</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span></div>
</div>



<span class="c1"># ---------------------------------------------------------------------------------------------</span>
<span class="c1"># Continuum data</span>
<span class="c1"># ---------------------------------------------------------------------------------------------</span>
<div class="viewcode-block" id="ContData">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.ContData">[docs]</a>
<span class="k">class</span> <span class="nc">ContData</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q3di</span><span class="p">):</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">q3di</span><span class="o">.</span><span class="n">label</span><span class="o">+</span><span class="s1">&#39;.cont.npy&#39;</span>
        <span class="n">datafile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">q3di</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ERROR: continuum (&#39;</span><span class="o">+</span><span class="n">filename</span><span class="o">+</span><span class="s1">&#39;) file does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_npy</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wave</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;wave&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qso_mod</span>        <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;qso_mod&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host_mod</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;host_mod&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poly_mod</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;poly_mod&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">npts</span>           <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;npts&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_sixgma</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_sigma&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_sigma_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_sigma_err&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_z</span>         <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_z&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_z_err</span>     <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_z_err&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_rchisq</span>    <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_rchisq&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_ebv</span>       <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_ebv&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stel_ebv_err</span>   <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;stel_ebv_err&#39;</span><span class="p">]</span>
        <span class="k">return</span>

<div class="viewcode-block" id="ContData.read_npy">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.ContData.read_npy">[docs]</a>
    <span class="k">def</span> <span class="nf">read_npy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datafile</span><span class="p">):</span>
        <span class="n">dataout</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="n">allow_pickle</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">colname</span> <span class="o">=</span> <span class="n">dataout</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dataout</span></div>
</div>


<span class="c1">##############################################################################</span>
<span class="c1"># code from W.Liu  - adapted from PPXF</span>
<span class="c1"># edited by Y.Ishikawa</span>
<span class="c1">##############################################################################</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Copyright (C) 2014-2017, Michele Cappellari</span>
<span class="sd">E-mail: michele.cappellari_at_physics.ox.ac.uk</span>

<span class="sd">Updated versions of the software are available from my web page</span>
<span class="sd">http://purl.org/cappellari/software</span>

<span class="sd">See example at the bottom for usage instructions.</span>

<span class="sd">MODIFICATION HISTORY:</span>
<span class="sd">    V1.0.0: Created to emulate my IDL procedure with the same name.</span>
<span class="sd">        Michele Cappellari, Oxford, 28 March 2014</span>
<span class="sd">    V1.0.1: Fixed treatment of optional parameters. MC, Oxford, 6 June 2014</span>
<span class="sd">    V1.0.2: Avoid potential runtime warning. MC, Oxford, 2 October 2014</span>
<span class="sd">    V1.0.3: Return axis. MC, Oxford, 26 March 2015</span>
<span class="sd">    V1.0.4: Return image instead of axis. MC, Oxford, 15 July 2015</span>
<span class="sd">    V1.0.5: Removes white gaps from rotated images using edgecolors.</span>
<span class="sd">        MC, Oxford, 5 October 2015</span>
<span class="sd">    V1.0.6: Pass kwargs to graphics functions.</span>
<span class="sd">        MC, Campos do Jordao, Brazil, 23 November 2015</span>
<span class="sd">    V1.0.7: Check that input (x,y) come from an axis-aligned image.</span>
<span class="sd">        MC, Oxford, 28 January 2016</span>
<span class="sd">    V1.0.8: Fixed deprecation warning in Numpy 1.11. MC, Oxford, 22 April 2016</span>
<span class="sd">    V1.1.0: Fixed program stop with kwargs. Included `colorbar` keyword.</span>
<span class="sd">        MC, Oxford, 18 May 2016</span>
<span class="sd">    V1.1.1: Use interpolation=&#39;nearest&#39; to avoid crash on MacOS.</span>
<span class="sd">        MC, Oxford, 14 June 2016</span>
<span class="sd">    V1.1.2: Specify origin=`upper` in imshow() for consistent results with older</span>
<span class="sd">        Matplotlib version. Thanks to Guillermo Bosch for reporting the issue.</span>
<span class="sd">        MC, Oxford, 6 January 2017</span>
<span class="sd">    V1.1.3: Simplified passing of default keywords. MC, Oxford, 20 February 2017</span>
<span class="sd">    V1.1.4: Use register_sauron_colormap(). MC, Oxford, 29 March 2017</span>
<span class="sd">    V1.1.5: Request `pixelsize` when dataset is large. Thanks to Davor</span>
<span class="sd">        Krajnovic (Potsdam) for the feedback. MC, Oxford, 10 July 2017</span>
<span class="sd">    V1.1.6: Fixed new incompatibility with Matplotlib 2.1.</span>
<span class="sd">        MC, Oxford, 9 November 2017</span>
<span class="sd">    V1.1.7: Changed imports for plotbin as a package. MC, Oxford, 17 April 2018</span>

<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="display_pixels_wz">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.display_pixels_wz">[docs]</a>
<span class="k">def</span> <span class="nf">display_pixels_wz</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">datIN</span><span class="p">,</span> <span class="n">PIXELSIZE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">VMIN</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">VMAX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">TICKS</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">PLOTLOG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ANGLE</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">COLORBAR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">AUTOCBAR</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">LABEL</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">NTICKS</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">CMAP</span><span class="o">=</span><span class="s1">&#39;RdYlBu&#39;</span><span class="p">,</span>
                      <span class="n">SKIPTICK</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">AX</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">XRAN</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">YRAN</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Display vectors of square pixels at coordinates (x,y) coloured with &quot;val&quot;.</span>
<span class="sd">    An optional rotation around the origin can be applied to the whole image.</span>

<span class="sd">    The pixels are assumed to be taken from a regular cartesian grid with</span>
<span class="sd">    constant spacing (like an axis-aligned image), but not all elements of</span>
<span class="sd">    the grid are required (missing data are OK).</span>

<span class="sd">    This routine is designed to be fast even with large images and to produce</span>
<span class="sd">    minimal file sizes when the output is saved in a vector format like PDF.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">VMIN</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">VMIN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">datIN</span><span class="p">[</span><span class="n">datIN</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">VMAX</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">VMAX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">datIN</span><span class="p">[</span><span class="n">datIN</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">])</span>

    <span class="c1"># print(VMIN,VMAX)</span>
    <span class="k">if</span> <span class="n">XRAN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">XRAN</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">XRAN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xmax</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">YRAN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">YRAN</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">YRAN</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ymax</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">imgPLT</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PLOTLOG</span><span class="p">:</span>
        <span class="n">imgPLT</span> <span class="o">=</span> <span class="n">AX</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">datIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="c1"># origin=&#39;lower&#39;,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span>
                           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                           <span class="n">vmin</span><span class="o">=</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">VMAX</span><span class="p">,</span>
                           <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">imgPLT</span> <span class="o">=</span> <span class="n">AX</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">rot90</span><span class="p">(</span><span class="n">datIN</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
                           <span class="c1"># origin=&#39;lower&#39;,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="n">CMAP</span><span class="p">,</span>
                           <span class="n">extent</span><span class="o">=</span><span class="p">[</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">],</span>
                           <span class="n">norm</span><span class="o">=</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">VMAX</span><span class="p">),</span>
                           <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">)</span>

    <span class="n">current_cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">()</span>
    <span class="n">current_cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">COLORBAR</span><span class="p">:</span>
        <span class="n">divider</span> <span class="o">=</span> <span class="n">make_axes_locatable</span><span class="p">(</span><span class="n">AX</span><span class="p">)</span>
        <span class="n">cax</span> <span class="o">=</span> <span class="n">divider</span><span class="o">.</span><span class="n">append_axes</span><span class="p">(</span><span class="s2">&quot;top&quot;</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="s2">&quot;5%&quot;</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">cax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">TICKS</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">AUTOCBAR</span><span class="p">:</span>
                <span class="n">TICKS</span> <span class="o">=</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">NTICKS</span><span class="p">)</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">VMAX</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">TICKS</span> <span class="o">=</span> <span class="n">LinearLocator</span><span class="p">(</span><span class="n">NTICKS</span><span class="p">)</span><span class="o">.</span><span class="n">tick_values</span><span class="p">(</span><span class="n">VMIN</span><span class="p">,</span> <span class="n">VMAX</span><span class="p">)</span>
        <span class="n">cax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="c1"># plt.colorbar(imgPLT, cax=cax, ticks=TICKS, orientation=&#39;horizontal&#39;,</span>
        <span class="c1">#              ticklocation=&#39;top&#39;)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">VMIN</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">imgPLT</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">TICKS</span><span class="p">,</span>
                         <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">ticklocation</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">VMIN</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">imgPLT</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cax</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="n">TICKS</span><span class="p">,</span>
                         <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">ticklocation</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                         <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%.0e</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># cax.formatter.set_powerlimits((0, 0))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">AX</span><span class="p">)</span>  <span class="c1"># Activate main plot before returning</span>
    <span class="n">AX</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">SKIPTICK</span><span class="p">:</span>
        <span class="n">AX</span><span class="o">.</span><span class="n">minorticks_on</span><span class="p">()</span>
        <span class="n">AX</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;inout&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span>
                       <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">AX</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                       <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;inout&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
        <span class="n">AX</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;inout&#39;</span><span class="p">,</span>
                       <span class="n">bottom</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">left</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
    <span class="k">return</span></div>


<span class="c1">##############################################################################</span>
<span class="c1"># other functions</span>
<span class="c1">##############################################################################</span>

<span class="c1"># estimate the errors in logarithm from linear errors</span>
<div class="viewcode-block" id="lgerr">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.lgerr">[docs]</a>
<span class="k">def</span> <span class="nf">lgerr</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x1err</span><span class="p">,</span><span class="n">x2err</span><span class="p">,):</span>
    <span class="n">x1</span><span class="p">,</span><span class="n">x2</span><span class="p">,</span><span class="n">x1err</span><span class="p">,</span><span class="n">x2err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x1</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x1err</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x2err</span><span class="p">)</span>
    <span class="n">yd0</span> <span class="o">=</span> <span class="n">x1</span><span class="o">/</span><span class="n">x2</span>
    <span class="n">yd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">yd0</span><span class="p">)</span>
    <span class="n">yderr0</span> <span class="o">=</span> <span class="p">((</span><span class="n">x1err</span><span class="o">/</span><span class="n">x2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">x2err</span><span class="o">*</span><span class="n">x1</span><span class="o">/</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="n">lgyerrup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">yd0</span><span class="o">+</span><span class="n">yderr0</span><span class="p">)</span> <span class="o">-</span> <span class="n">yd</span>
    <span class="n">lgyerrlow</span> <span class="o">=</span> <span class="n">yd</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">yd0</span><span class="o">-</span><span class="n">yderr0</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">lgyerrlow</span><span class="p">,</span><span class="n">lgyerrup</span><span class="p">]</span></div>


<div class="viewcode-block" id="clean_mask">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.clean_mask">[docs]</a>
<span class="k">def</span> <span class="nf">clean_mask</span><span class="p">(</span><span class="n">dataIN</span><span class="p">,</span> <span class="n">BAD</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">):</span>
    <span class="n">dataOUT</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataIN</span><span class="p">)</span>
    <span class="n">dataOUT</span><span class="p">[</span><span class="n">dataIN</span> <span class="o">!=</span> <span class="n">BAD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dataOUT</span><span class="p">[</span><span class="n">dataIN</span> <span class="o">==</span> <span class="n">BAD</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># breakpoint()</span>
    <span class="k">return</span> <span class="n">dataOUT</span></div>


<div class="viewcode-block" id="snr_cut">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.snr_cut">[docs]</a>
<span class="k">def</span> <span class="nf">snr_cut</span><span class="p">(</span><span class="n">dataIN</span><span class="p">,</span><span class="n">errIN</span><span class="p">,</span><span class="n">SNRCUT</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">snr</span> <span class="o">=</span> <span class="n">dataIN</span><span class="o">/</span><span class="n">errIN</span>

    <span class="n">gud_indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">SNRCUT</span><span class="p">)</span>
    <span class="n">bad_indx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">SNRCUT</span><span class="p">)</span>
    <span class="n">dataOUT</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">dataIN</span><span class="p">)</span>
    <span class="n">dataOUT</span><span class="p">[</span><span class="n">snr</span> <span class="o">&lt;</span> <span class="n">SNRCUT</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">dataOUT</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">errIN</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">return</span> <span class="n">dataOUT</span><span class="p">,</span><span class="n">gud_indx</span><span class="p">,</span><span class="n">bad_indx</span></div>


<div class="viewcode-block" id="save_to_fits">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.save_to_fits">[docs]</a>
<span class="k">def</span> <span class="nf">save_to_fits</span><span class="p">(</span><span class="n">dataIN</span><span class="p">,</span><span class="n">hdrIN</span><span class="p">,</span><span class="n">savepath</span><span class="p">):</span>
    <span class="c1"># if not os.path.isfile(savepath):</span>
        <span class="c1"># shutil.copy(datpath1,savepath)</span>
    <span class="k">if</span> <span class="n">hdrIN</span> <span class="o">==</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">hdrIN</span> <span class="o">==</span> <span class="p">[]:</span>
        <span class="n">hdu_0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">dataIN</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hdu_0</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">dataIN</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="n">hdrIN</span><span class="p">)</span>
    <span class="n">hdul</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">HDUList</span><span class="p">([</span><span class="n">hdu_0</span><span class="p">])</span>
    <span class="n">hdul</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">savepath</span><span class="p">,</span><span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span></div>


<div class="viewcode-block" id="set_figSize">
<a class="viewcode-back" href="../../source/q3dfit.html#q3dfit.q3dpro.set_figSize">[docs]</a>
<span class="k">def</span> <span class="nf">set_figSize</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span><span class="n">plotsize</span><span class="p">,</span><span class="n">SQUARE</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
    <span class="n">xy</span> <span class="o">=</span> <span class="p">[</span><span class="mf">12.</span><span class="p">,</span><span class="mf">14.</span><span class="p">]</span>
    <span class="n">figSIZE</span> <span class="o">=</span> <span class="mf">5.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">plotsize</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float&#39;</span><span class="p">)</span><span class="o">/</span><span class="mf">5.</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">figSIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">figSIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">plotsize</span>
    <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">figSIZE</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="p">:</span>
        <span class="k">if</span> <span class="n">figSIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">figSIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">figSIZE</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">figSIZE</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">figSIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">figSIZE</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">figSIZE</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span>
        <span class="n">figSIZE</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">figSIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mf">2.</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">figSIZE</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="n">xy</span><span class="p">))</span>
        <span class="n">figSIZE</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">)]</span>
    <span class="n">figSIZE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">figSIZE</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">figSIZE</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, David Rupke and the Q3D Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>